<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MONITORING GFORM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{font-family:Calibri,Arial,Helvetica,sans-serif;background:#f5f7fa;color:#222;margin:0}
header{background:#1e5bb8;color:#fff;padding:14px 18px;font-weight:700;text-align:center}
.wrap{padding:16px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.btn{background:#1e5bb8;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.btn-switch{background:#f0f0f0;color:#222}
.week-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);min-height:120px;overflow:auto}
.card h4{color:#000;padding:6px;border-radius:4px;text-align:center;font-size:14px}
.item{padding:4px 0;border-bottom:1px solid #eee;font-size:13px}
small{color:#666;font-size:11px}
.chart-wrap{background:#fff;padding:12px;border-radius:8px;width:100%;text-align:center;margin-top:12px}
.chart-wrap canvas{display:inline-block;transform:scale(0.5);transform-origin:top center}
</style>
</head>
<body>
<header>MONITORING GFORM</header>
<div class="wrap">
  <div class="controls">
    <button class="btn" id="btnWeekly">Weekly</button>
    <button class="btn" id="btnMonthly">Monthly</button>
    <button class="btn" id="btnExport">Export Excel</button>
    <button class="btn" id="btnRefresh">Refresh Now</button>
  </div>

  <!-- WEEKLY DASHBOARD -->
  <div id="weeklyDashboard">
    <div class="week-grid">
      <div class="card" id="cardW1"><h4>WEEK 1</h4><div id="sudahW1">—</div><div id="countSW1"></div></div>
      <div class="card" id="cardW2"><h4>WEEK 2</h4><div id="sudahW2">—</div><div id="countSW2"></div></div>
      <div class="card" id="cardW3"><h4>WEEK 3</h4><div id="sudahW3">—</div><div id="countSW3"></div></div>
      <div class="card" id="cardW4"><h4>WEEK 4</h4><div id="sudahW4">—</div><div id="countSW4"></div></div>
    </div>
    <h3>Belum Terinput</h3>
    <div class="week-grid">
      <div class="card"><h4>W1</h4><div id="belumW1">—</div><div id="countBW1"></div></div>
      <div class="card"><h4>W2</h4><div id="belumW2">—</div><div id="countBW2"></div></div>
      <div class="card"><h4>W3</h4><div id="belumW3">—</div><div id="countBW3"></div></div>
      <div class="card"><h4>W4</h4><div id="belumW4">—</div><div id="countBW4"></div></div>
    </div>
    <div class="chart-wrap">
      <h4>Grafik per SEKTOR</h4>
      <canvas id="chartWeekly"></canvas>
    </div>
  </div>

  <!-- MONTHLY DASHBOARD -->
  <div id="monthlyDashboard" style="display:none">
    <h3>Sudah Input</h3>
    <div class="week-grid" id="monthlySudah"></div>
    <h3>Belum Input</h3>
    <div class="week-grid" id="monthlyBelum"></div>
    <div class="chart-wrap">
      <h4>Grafik per SEKTOR</h4>
      <canvas id="chartMonthly"></canvas>
    </div>
  </div>

</div>

<script>
const MASTER_CSV="Data Mesin.csv";
const WEEKLY_SHEET_URL="https://opensheet.elk.sh/YOUR_WEEKLY_SHEET_ID/Form Responses 1";
const MONTHLY_SHEET_URL="https://docs.google.com/spreadsheets/d/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/export?format=csv&gid=1674075217";

function safe(v){return v==null?"":String(v).trim();}
function parseWeek(raw){const m=String(raw).match(/(\d)/);const n=m?parseInt(m[1],10):1;return(n>=1&&n<=4)?n:1;}

let masterList=[], weeklyRows=[], monthlyRows=[], chartWeekly=null, chartMonthly=null;

async function loadCSV(url){return new Promise(resolve=>{
  Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:e=>{console.warn(e);resolve([]);}});
});}

async function loadAll(){
  masterList=await loadCSV(MASTER_CSV);
  weeklyRows=await fetch(WEEKLY_SHEET_URL).then(r=>r.json()).catch(e=>{console.warn(e);return[];});
  monthlyRows=await loadCSV(MONTHLY_SHEET_URL);
  renderWeekly();
  renderMonthly();
}

// --- RENDER WEEKLY ---
function renderWeekly(){
  const sudah={1:[],2:[],3:[],4:[]}, belum={1:[],2:[],3:[],4:[]}, sektorCount={};
  for(let w=1;w<=4;w++){
    const masterThisWeek=masterList.filter(m=>parseWeek(m.WEEK)===w);
    for(const m of masterThisWeek){
      const id=safe(m["ID Mesin"]), sektor=safe(m.SEKTOR)||"—", nama=safe(m["Nama Lokasi"])||"—";
      const match=weeklyRows.find(r=>safe(r["ID Mesin"])===id && parseWeek(r.WEEK)===w);
      if(match){sudah[w].push({id,sektor,nama,timestamp:safe(match.Timestamp)||"—",week:`Week ${w}`});sektorCount[sektor]=(sektorCount[sektor]||0)+1;}
      else{belum[w].push({id,sektor,nama,timestamp:"—",week:`Week ${w}`});}
    }
  }
  for(let w=1;w<=4;w++){
    document.getElementById("sudahW"+w).innerHTML = sudah[w].length?sudah[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.nama}<br><small>${it.week} • ${it.timestamp}</small></div>`).join(""):"<i>Tidak ada data</i>";
    document.getElementById("belumW"+w).innerHTML = belum[w].length?belum[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.nama}</div>`).join(""):"<i>Semua mesin terinput</i>";
    document.getElementById("countSW"+w).innerText=`Total: ${sudah[w].length} mesin`;
    document.getElementById("countBW"+w).innerText=`Total: ${belum[w].length} mesin`;
  }
  const labels=Object.keys(sektorCount), counts=labels.map(l=>sektorCount[l]);
  const ctx=document.getElementById("chartWeekly").getContext("2d");
  if(chartWeekly) chartWeekly.destroy();
  chartWeekly=new Chart(ctx,{type:"pie",data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},options:{responsive:false}});
}

// --- RENDER MONTHLY ---
function renderMonthly(){
  const sudahList=[], belumList=[], sektorCount={};
  for(const m of masterList){
    const id=safe(m["ID Mesin"]), sektor=safe(m.SEKTOR)||"—", nama=safe(m["Nama Lokasi"])||"—";
    const match=monthlyRows.find(r=>safe(r["ID Mesin"])===id);
    if(match){sudahList.push({id,sektor,nama,timestamp:safe(match.Timestamp)||"—"});sektorCount[sektor]=(sektorCount[sektor]||0)+1;}
    else{belumList.push({id,sektor,nama,timestamp:"—"});}
  }
  // sudah input 4 kolom
  const colS=[];for(let i=0;i<4;i++){colS.push(sudahList.filter((_,idx)=>idx%4===i));}
  const monthlySudah=document.getElementById("monthlySudah");monthlySudah.innerHTML="";for(let i=0;i<4;i++){const div=document.createElement("div");div.className="card";div.innerHTML=colS[i].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.nama}<br><small>${it.timestamp}</small></div>`).join("");monthlySudah.appendChild(div);}
  // belum input 4 kolom
  const colB=[];for(let i=0;i<4;i++){colB.push(unbelList=[]);colB[i]=unbelList=belumList.filter((_,idx)=>idx%4===i);}
  const monthlyBelum=document.getElementById("monthlyBelum");monthlyBelum.innerHTML="";for(let i=0;i<4;i++){const div=document.createElement("div");div.className="card";div.innerHTML=colB[i].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.nama}</div>`).join("");monthlyBelum.appendChild(div);}
  const labels=Object.keys(sektorCount), counts=labels.map(l=>sektorCount[l]);
  const ctx=document.getElementById("chartMonthly").getContext("2d");
  if(chartMonthly) chartMonthly.destroy();
  chartMonthly=new Chart(ctx,{type:"pie",data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},options:{responsive:false}});
}

// --- SWITCH TAB ---
document.getElementById("btnWeekly").addEventListener("click",()=>{document.getElementById("weeklyDashboard").style.display="block";document.getElementById("monthlyDashboard").style.display="none";});
document.getElementById("btnMonthly").addEventListener("click",()=>{document.getElementById("weeklyDashboard").style.display="none";document.getElementById("monthlyDashboard").style.display="block";});

// --- REFRESH & EXPORT ---
document.getElementById("btnRefresh").addEventListener("click",()=>loadAll());
document.getElementById("btnExport").addEventListener("click",()=>{
  const rows=[];
  if(document.getElementById("weeklyDashboard").style.display==="block"){
    for(let w=1;w<=4;w++){const masterThisWeek=masterList.filter(m=>parseWeek(m.WEEK)===w);for(const m of masterThisWeek){const id=safe(m["ID Mesin"]),sektor=safe(m.SEKTOR)||"—",nama=safe(m["Nama Lokasi"])||"—";const match=weeklyRows.find(r=>safe(r["ID Mesin"])===id && parseWeek(r.WEEK)===w);rows.push({Timestamp:match?safe(match.Timestamp)||"—":"—",ID_Mesin:id,Nama_Lokasi:match?safe(match["Nama Lokasi"])||nama:nama,WEEK:`Week ${w}`,SEKTOR:sektor});}}
  }else{
    for(const m of masterList){const id=safe(m["ID Mesin"]),sektor=safe(m.SEKTOR)||"—",nama=safe(m["Nama Lokasi"])||"—";const match=monthlyRows.find(r=>safe(r["ID Mesin"])===id);rows.push({Timestamp:match?safe(match.Timestamp)||"—":"—",ID_Mesin:id,Nama_Lokasi:nama,WEEK:"Month",SEKTOR:sektor});}
  }
  const wb=XLSX.utils.book_new(),ws=XLSX.utils.json_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,"Monitoring");XLSX.writeFile(wb,`Monitoring_${new Date().toISOString().slice(0,10)}.xlsx`);
});

loadAll();
setInterval(loadAll,600000);
</script>
</body>
</html>
