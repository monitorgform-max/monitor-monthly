<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MONITORING GFORM WEEKLY & MONTHLY</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body{font-family:Calibri,Arial,Helvetica,sans-serif;background:#f5f7fa;color:#222;margin:0}
  header{background:#1e5bb8;color:#fff;padding:14px 18px;font-weight:700;text-align:center}
  .wrap{padding:16px}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .btn{background:#1e5bb8;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  .week-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);min-height:160px;overflow:auto}
  .item{padding:4px 0;border-bottom:1px solid #eee;font-size:13px}
  small{color:#666;font-size:12px}
  /* Header warna pastel */
  #cardW1 h4, #cardBW1 h4{background:#FFD1DC;color:#000;padding:4px;text-align:center;border-radius:4px;}
  #cardW2 h4, #cardBW2 h4{background:#D1E8FF;color:#000;padding:4px;text-align:center;border-radius:4px;}
  #cardW3 h4, #cardBW3 h4{background:#D1FFD6;color:#000;padding:4px;text-align:center;border-radius:4px;}
  #cardW4 h4, #cardBW4 h4{background:#FFF6D1;color:#000;padding:4px;text-align:center;border-radius:4px;}
  #chartWrap{text-align:center;margin-top:16px;background:#fff;padding:12px;border-radius:8px;}
  .grid4col{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
</style>
</head>
<body>
<header>MONITORING GFORM WEEKLY & MONTHLY</header>
<div class="wrap">
  <div class="controls">
    <button class="btn" id="btnExport">Export Excel</button>
    <button class="btn" id="btnRefresh">Refresh Now</button>
    <div style="margin-left:8px;color:#666;font-size:13px">Auto-refresh 10 menit — shows Timestamp, ID Mesin, Nama Lokasi, WEEK, SEKTOR</div>
  </div>

  <h3>Weekly - Sudah Input</h3>
  <div class="week-grid">
    <div class="card" id="cardW1"><h4>WEEK 1</h4><div id="sudahW1">—</div><div id="countSW1" style="margin-top:4px"></div></div>
    <div class="card" id="cardW2"><h4>WEEK 2</h4><div id="sudahW2">—</div><div id="countSW2" style="margin-top:4px"></div></div>
    <div class="card" id="cardW3"><h4>WEEK 3</h4><div id="sudahW3">—</div><div id="countSW3" style="margin-top:4px"></div></div>
    <div class="card" id="cardW4"><h4>WEEK 4</h4><div id="sudahW4">—</div><div id="countSW4" style="margin-top:4px"></div></div>
  </div>

  <h3>Weekly - Belum Input</h3>
  <div class="week-grid">
    <div class="card" id="cardBW1"><h4>W1</h4><div id="belumW1">—</div><div id="countBW1" style="margin-top:4px"></div></div>
    <div class="card" id="cardBW2"><h4>W2</h4><div id="belumW2">—</div><div id="countBW2" style="margin-top:4px"></div></div>
    <div class="card" id="cardBW3"><h4>W3</h4><div id="belumW3">—</div><div id="countBW3" style="margin-top:4px"></div></div>
    <div class="card" id="cardBW4"><h4>W4</h4><div id="belumW4">—</div><div id="countBW4" style="margin-top:4px"></div></div>
  </div>

  <h3>Monthly - Sudah Input</h3>
  <div class="grid4col" id="monthlySdh">—</div>

  <h3>Monthly - Belum Input</h3>
  <div class="grid4col" id="monthlyBlm">—</div>

  <div id="chartWrap">
    <h4>Grafik per SEKTOR</h4>
    <canvas id="chartSektor" width="300" height="300"></canvas>
  </div>
</div>

<script>
/* CONFIG */
const MASTER_CSV = "Data Mesin.csv";
const WEEKLY_FORM = "https://docs.google.com/spreadsheets/d/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/export?format=csv&gid=1674075217"; // weekly
const MONTHLY_FORM = "https://docs.google.com/spreadsheets/d/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/export?format=csv&gid=1674075217"; // monthly

function safe(v){return v==null?"":String(v).trim();}
function parseWeek(raw){const m=String(raw).match(/(\d)/); const n=m?parseInt(m[1],10):1; return (n>=1&&n<=4)?n:1;}

let masterList=[], weeklyRows=[], monthlyRows=[], chart=null;

async function loadMaster(){
  return new Promise(resolve=>{
    Papa.parse(MASTER_CSV,{download:true,header:true,skipEmptyLines:true,
      complete:r=>{ masterList = Array.isArray(r.data)? r.data.filter(x=>safe(x["ID Mesin"])!=="") : []; console.log("master count:", masterList.length); resolve(); },
      error:e=>{ console.warn("failed load master:",e); masterList=[]; resolve(); }
    });
  });
}

async function loadCsv(url){
  return new Promise(resolve=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:e=>{console.warn("failed load csv",e); resolve([]);}});
  });
}

function renderWeekly(){
  const sudah={1:[],2:[],3:[],4:[]}, belum={1:[],2:[],3:[],4:[]}, sektorCount={};

  for(let w=1; w<=4; w++){
    const masterThisWeek = masterList.filter(m=>parseWeek(m["WEEK"])===w);
    for(const m of masterThisWeek){
      const id = safe(m["ID Mesin"]);
      const sektor = safe(m["SEKTOR"])||"—";
      const namaLokasi = safe(m["Nama Lokasi"])||"—";
      const match = weeklyRows.find(r=>safe(r["ID Mesin"])===id && parseWeek(r["WEEK"])===w);
      if(match){
        sudah[w].push({id, sektor, namaLokasi, timestamp:safe(match["Timestamp"])||"—"});
        sektorCount[sektor]=(sektorCount[sektor]||0)+1;
      }else{
        belum[w].push({id, sektor, namaLokasi});
      }
    }
  }

  for(let w=1; w<=4; w++){
    document.getElementById("sudahW"+w).innerHTML = sudah[w].length?sudah[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}<br><small>Week ${w} • ${it.timestamp}</small></div>`).join(""):"<i>Tidak ada data</i>";
    document.getElementById("belumW"+w).innerHTML = belum[w].length?belum[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}</div>`).join(""):"<i>Semua mesin terinput</i>";
    document.getElementById("countSW"+w).innerText = `Total: ${sudah[w].length} mesin`;
    document.getElementById("countBW"+w).innerText = `Total: ${belum[w].length} mesin`;
  }

  const labels = Object.keys(sektorCount);
  const counts = labels.map(l=>sektorCount[l]);
  const ctx = document.getElementById("chartSektor").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{type:"pie",data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},options:{responsive:false}});
}

function renderMonthly(){
  const sudah=[], belum=[], sektorCount={};

  for(const m of masterList){
    const id = safe(m["ID Mesin"]);
    const sektor = safe(m["SEKTOR"])||"—";
    const namaLokasi = safe(m["Nama Lokasi"])||"—";
    const match = monthlyRows.find(r=>safe(r["ID Mesin"])===id);
    if(match){
      sudah.push({id,sektor,namaLokasi,timestamp:safe(match["Timestamp"])||"—"});
      sektorCount[sektor]=(sektorCount[sektor]||0)+1;
    }else{
      belum.push({id,sektor,namaLokasi});
    }
  }

  const gridSdh = document.getElementById("monthlySdh");
  const gridBlm = document.getElementById("monthlyBlm");
  gridSdh.innerHTML = sudah.length?sudah.map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}<br><small>${it.timestamp}</small></div>`).join(""):"<i>Tidak ada data</i>";
  gridBlm.innerHTML = belum.length?belum.map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}</div>`).join(""):"<i>Semua mesin terinput</i>";
}

document.getElementById("btnRefresh").addEventListener("click",()=>loadAll());
document.getElementById("btnExport").addEventListener("click",()=>{
  const rows=[];
  for(let w=1; w<=4; w++){
    const masterThisWeek = masterList.filter(m=>parseWeek(m["WEEK"])===w);
    for(const m of masterThisWeek){
      const id = safe(m["ID Mesin"]);
      const sektor = safe(m["SEKTOR"])||"—";
      const namaLokasi = safe(m["Nama Lokasi"])||"—";
      const match = weeklyRows.find(r=>safe(r["ID Mesin"])===id && parseWeek(r["WEEK"])===w);
      if(match){ rows.push({Timestamp:safe(match["Timestamp"])||"—",ID_Mesin:id,Nama_Lokasi:safe(match["Nama Lokasi"])||namaLokasi,WEEK:`Week ${w}`,SEKTOR:sektor}); }
      else{ rows.push({Timestamp:"—",ID_Mesin:id,Nama_Lokasi:namaLokasi,WEEK:`Week ${w}`,SEKTOR:sektor}); }
    }
  }
  for(const m of masterList){
    const id = safe(m["ID Mesin"]);
    const sektor = safe(m["SEKTOR"])||"—";
    const namaLokasi = safe(m["Nama Lokasi"])||"—";
    const match = monthlyRows.find(r=>safe(r["ID Mesin"])===id);
    if(match){ rows.push({Timestamp:safe(match["Timestamp"])||"—",ID_Mesin:id,Nama_Lokasi:namaLokasi,WEEK:"Monthly",SEKTOR:sektor}); }
    else{ rows.push({Timestamp:"—",ID_Mesin:id,Nama_Lokasi:namaLokasi,WEEK:"Monthly",SEKTOR:sektor}); }
  }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Monitoring");
  XLSX.writeFile(wb,`Monitoring_${new Date().toISOString().slice(0,10)}.xlsx`);
});

async function loadAll(){
  await loadMaster();
  weeklyRows = await loadCsv(WEEKLY_FORM);
  monthlyRows = await loadCsv(MONTHLY_FORM);
  renderWeekly();
  renderMonthly();
}

loadAll();
setInterval(loadAll,600000);
</script>
</body>
</html>
