<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITORING GFORM - FINAL</title>

<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{--blue:#1e5bb8;--bg:#f5f7fa;--card:#fff}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  header{background:var(--blue);color:#fff;padding:14px 16px;position:fixed;top:0;left:0;right:0;z-index:50;font-weight:700}
  .wrap{padding:18px;padding-top:92px}
  .button-row{position:fixed;top:60px;left:0;right:0;padding:10px 16px;background:var(--bg);display:flex;gap:8px;z-index:49}
  .btn{background:var(--blue);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  .btn.active{background:#d9534f}
  .el-btn{position:relative;padding:8px 14px;border-radius:8px;border:none;background:var(--blue);color:#fff;cursor:pointer;font-weight:700;overflow:hidden}
  .week-row{display:none;position:fixed;top:104px;left:0;right:0;padding:10px 16px;background:var(--bg);gap:8px;z-index:48}
  .week-btn{background:#666;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
  .week-btn.active{background:#d9534f}
  #dataDisplay{margin-top:160px;padding:12px}
  .card{background:var(--card);padding:10px;border-radius:8px;margin-bottom:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06)}
  .week-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  .card.sudah{background:#e9f7ef}
  .card.belum{background:#fff0f0}
  .item{padding:8px;border-radius:6px;border:1px solid #eee;background:#fff;font-size:13px}
  #loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);color:#0ff;z-index:9999}
  #loader h1{margin:0 0 8px 0;font-size:24px}
  @media (max-width:800px){ .week-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
<header>MONITORING GFORM - FINAL</header>

<div class="button-row">
  <button class="btn" id="btnWeekly">Weekly</button>
  <button class="btn" id="btnMonthly">Monthly</button>
  <button class="btn" id="btnExport">Export (.xlsx)</button>
  <button class="btn" id="btnRefresh">Refresh</button>
  <button class="el-btn" id="btnEL">EL âš¡</button>
</div>

<div class="week-row" id="weekButtons">
  <button class="week-btn" data-week="1">W1</button>
  <button class="week-btn" data-week="2">W2</button>
  <button class="week-btn" data-week="3">W3</button>
  <button class="week-btn" data-week="4">W4</button>
</div>

<div id="loader">
  <h1>LOADING......PLEASE WAIT....!!</h1>
  <div class="card">Memuat data... sabar bre ðŸ˜‰</div>
</div>

<div class="wrap">
  <div id="dataDisplay"></div>
</div>

<script>
/* -------------------------
   CONFIG - sesuaikan di sini
   ------------------------- */
const MASTER_WEEKLY_CSV = "Data Mesin.csv";            // file CSV di repo (relative)
const MASTER_MONTHLY_CSV = "Data Mesin Monthly.csv";  // file CSV di repo (relative)

// OpenSheet fallback (jika kamu mau pake Google Sheet public)
// contoh ID sudah sesuai percakapan awal; ganti kalau perlu
const WEEKLY_SHEET_ID = "19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck";
const WEEKLY_SHEET_NAME = "Form Responses 1";
const WEEKLY_SHEET_URL = `https://opensheet.elk.sh/${WEEKLY_SHEET_ID}/${encodeURIComponent(WEEKLY_SHEET_NAME)}`;

const MONTHLY_FORM_URL = "https://opensheet.elk.sh/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/Form%20Responses%201";

/* -------------------------
   STATE
   ------------------------- */
const btnWeekly = document.getElementById("btnWeekly");
const btnMonthly = document.getElementById("btnMonthly");
const btnExport = document.getElementById("btnExport");
const btnRefresh = document.getElementById("btnRefresh");
const btnEL = document.getElementById("btnEL");
const weekButtons = document.getElementById("weekButtons");
const weekBtns = document.querySelectorAll(".week-btn");
const dataDisplay = document.getElementById("dataDisplay");
const loader = document.getElementById("loader");

let masterWeekly = [];   // array dari CSV master weekly
let masterMonthly = [];  // array dari CSV master monthly
let weeklyRows = [];     // array dari OpenSheet weekly responses (opsional)
let monthlyRows = [];    // array dari OpenSheet monthly responses (opsional)
let currentView = null;  // "weekly" or "monthly"
let currentWeek = null;

/* -------------------------
   UTIL
   ------------------------- */
function safe(v){ return v==null?"":String(v).trim(); }
function showLoader(){ loader.style.display = "flex"; }
function hideLoader(){ loader.style.display = "none"; }
function resetMainButtons(){ [btnWeekly, btnMonthly, btnExport, btnRefresh, btnEL].forEach(b=>b.classList.remove("active")); }
function resetWeekButtons(){ weekBtns.forEach(b=>b.classList.remove("active")); }

/* -------------------------
   CSV LOAD (PapaParse) with fallback
   - Try load local CSV first, else fallback to OpenSheet (for responses)
   ------------------------- */
async function loadCSVWithFetch(path){
  try{
    // try fetch local CSV (or remote raw CSV)
    const res = await fetch(path);
    if(!res.ok) throw new Error("not ok");
    const text = await res.text();
    return Papa.parse(text, {header:true, skipEmptyLines:true}).data;
  }catch(e){
    console.warn("CSV load failed for", path, e);
    return [];
  }
}

async function loadOpenSheet(url){
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error("opensheet fail");
    const json = await r.json();
    return json;
  }catch(e){
    console.warn("opensheet fetch failed", url, e);
    return [];
  }
}

async function loadAll(){
  // load master CSVs
  masterWeekly = await loadCSVWithFetch(MASTER_WEEKLY_CSV);
  masterMonthly = await loadCSVWithFetch(MASTER_MONTHLY_CSV);

  // load sheets (responses) â€” non-blocking fallback if not needed
  weeklyRows = await loadOpenSheet(WEEKLY_SHEET_URL);
  monthlyRows = await loadOpenSheet(MONTHLY_FORM_URL);

  // ensure arrays exist
  masterWeekly = masterWeekly || [];
  masterMonthly = masterMonthly || [];
  weeklyRows = weeklyRows || [];
  monthlyRows = monthlyRows || [];
}

/* -------------------------
   Render helpers
   ------------------------- */
function chunkArray(arr, cols=4){
  const out = Array.from({length:cols},()=>[]);
  if(arr.length===0) return out;
  let idx=0, base=Math.floor(arr.length/cols), rem=arr.length%cols;
  for(let i=0;i<cols;i++){
    const size = base + (i<rem?1:0);
    out[i] = arr.slice(idx, idx+size);
    idx += size;
  }
  return out;
}

/* -------------------------
   RENDER WEEKLY
   ------------------------- */
function renderWeekly(week){
  currentView="weekly";
  currentWeek=week;
  resetMainButtons();
  btnWeekly.classList.add("active");
  weekButtons.style.display="flex";
  resetWeekButtons();
  document.querySelectorAll(`.week-btn[data-week="${week}"]`).forEach(b=>b.classList.add("active"));

  // Master list filter by WEEK column â€” be tolerant of casing
  const list = masterWeekly.filter(m => {
    const w = safe(m.WEEK || m.Week || m.week || m['Week']);
    return w === `Week ${week}` || w === `W${week}` || w === `${week}`;
  });

  // Build sudah / belum by matching ID Mesin with weeklyRows responses (if available)
  const sudahList = [];
  const belumList = [];
  list.forEach(m=>{
    const id = safe(m["ID Mesin"] || m["Id Mesin"] || m.ID || m['ID']);
    const match = weeklyRows.find(r => safe(r["ID Mesin"]) === id && (safe(r.WEEK) === `Week ${week}` || safe(r.WEEK) === `W${week}` || safe(r.WEEK) === `${week}`));
    if(match) sudahList.push({...m, Timestamp: safe(match.Timestamp || match.timestamp || match.TimeStamp)});
    else belumList.push(m);
  });

  // build html
  let html = `<div class="card"><strong>Weekly â€” Week ${week}</strong> Â· Sudah: ${sudahList.length} Â· Belum: ${belumList.length}</div>`;

  const colSud = chunkArray(sudahList,4);
  html += `<h3>Sudah Input (${sudahList.length} mesin)</h3>`;
  html += `<div class="week-grid">` + colSud.map(col=>`<div>${col.map(m=>`<div class="card sudah"><div class="item"><strong>${safe(m["ID Mesin"])}</strong><div>${safe(m.SEKTOR||m.Sektor||"â€”")}</div><div>${safe(m["Nama Lokasi"]||m.Nama||"â€”")}</div><div style="font-size:12px;color:#333;margin-top:6px"><small>${safe(m.Timestamp||m.Timestamp)}</small></div></div></div>`).join('')}</div>`).join('') + `</div>`;

  const colBel = chunkArray(belumList,4);
  html += `<h3>Belum Input (${belumList.length} mesin)</h3>`;
  html += `<div class="week-grid">` + colBel.map(col=>`<div>${col.map(m=>`<div class="card belum"><div class="item"><strong>${safe(m["ID Mesin"])}</strong><div>${safe(m.SEKTOR||m.Sektor||"â€”")}</div><div>${safe(m["Nama Lokasi"]||m.Nama||"â€”")}</div></div></div>`).join('')}</div>`).join('') + `</div>`;

  dataDisplay.innerHTML = html;
}

/* -------------------------
   RENDER MONTHLY
   ------------------------- */
function renderMonthly(){
  currentView="monthly";
  resetMainButtons();
  btnMonthly.classList.add("active");
  weekButtons.style.display="none";

  // build lists
  const sudah=[], belum=[];
  masterMonthly.forEach(m=>{
    const id = safe(m["ID Mesin"]||m.ID||m["Id Mesin"]);
    const nama = safe(m["Nama Lokasi"]||m.Nama||"â€”");
    const sektor = safe(m.Sektor||m.SEKTOR||m.sektor||"â€”");
    const match = monthlyRows.find(r => safe(r["ID Mesin"]) === id);
    if(match){
      let ts = safe(match.Timestamp || match.timestamp || "");
      const d = new Date(ts);
      if(!isNaN(d)) ts = d.toLocaleString("id-ID",{hour12:false});
      sudah.push({id,nama,sektor,ts});
    } else {
      belum.push({id,nama,sektor});
    }
  });

  let html = `<div class="card"><strong>Monthly</strong> Â· Sudah: ${sudah.length} Â· Belum: ${belum.length}</div>`;

  const colSud = chunkArray(sudah,4);
  html += `<h3>Sudah Input (${sudah.length})</h3>` + colSud.map(col=>`<div class="week-grid">`+ col.map(c=>`<div class="monthly-card sudah card"><div class="item"><strong>${c.id}</strong><div>${c.sektor}</div><div>${c.nama}</div><div style="font-size:12px;margin-top:6px">${c.ts}</div></div></div>`).join('') + `</div>`).join('');

  const colBel = chunkArray(belum,4);
  html += `<h3>Belum Input (${belum.length})</h3>` + colBel.map(col=>`<div class="week-grid">`+ col.map(c=>`<div class="monthly-card belum card"><div class="item"><strong>${c.id}</strong><div>${c.sektor}</div><div>${c.nama}</div></div></div>`).join('') + `</div>`).join('');

  dataDisplay.innerHTML = html;
}

/* -------------------------
   BUTTON HANDLERS
   ------------------------- */
btnWeekly.addEventListener("click", async ()=>{
  // show week buttons
  resetMainButtons(); btnWeekly.classList.add("active");
  weekButtons.style.display = "flex";
  // ensure masterWeekly is loaded
  if(masterWeekly.length===0 && masterMonthly.length===0 && weeklyRows.length===0 && monthlyRows.length===0){
    showLoader();
    await loadAll();
    hideLoader();
  }
  dataDisplay.innerHTML = `<div class="card">Pilih week untuk melihat data</div>`;
});

weekBtns.forEach(b=>{
  b.addEventListener("click", async (ev)=>{
    const w = b.dataset.week;
    resetWeekButtons(); b.classList.add("active");
    if(masterWeekly.length===0) { showLoader(); await loadAll(); hideLoader(); }
    renderWeekly(w);
  });
});

btnMonthly.addEventListener("click", async ()=>{
  resetMainButtons(); btnMonthly.classList.add("active");
  weekButtons.style.display = "none";
  if(masterMonthly.length===0) { showLoader(); await loadAll(); hideLoader(); }
  renderMonthly();
});

/* -------------------------
   Export to Excel (.xlsx)
   - Exports the currently displayed dataset:
     * If currentView === "weekly" => export the masterWeekly rows for that week
     * If currentView === "monthly" => export masterMonthly
   ------------------------- */
btnExport.addEventListener("click", ()=>{
  if(currentView === "weekly" && currentWeek){
    // prepare data for that week
    const rows = masterWeekly.filter(m => {
      const w = safe(m.WEEK || m.Week || m.week || "");
      return w === `Week ${currentWeek}` || w === `W${currentWeek}` || w === `${currentWeek}`;
    });
    if(rows.length === 0){ alert("Tidak ada data untuk week ini."); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `Week_${currentWeek}`);
    XLSX.writeFile(wb, `Weekly_Week_${currentWeek}.xlsx`);
    return;
  }

  if(currentView === "monthly"){
    if(masterMonthly.length === 0){ alert("Tidak ada data monthly."); return; }
    const ws = XLSX.utils.json_to_sheet(masterMonthly);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Monthly");
    XLSX.writeFile(wb, "Monthly.xlsx");
    return;
  }

  alert("Pilih Weekly (pilih week) atau Monthly terlebih dahulu sebelum export.");
});

/* -------------------------
   Refresh
   ------------------------- */
btnRefresh.addEventListener("click", async ()=>{
  resetMainButtons(); btnRefresh.classList.add("active");
  showLoader();
  await loadAll();
  hideLoader();
  dataDisplay.innerHTML = `<div class="card">Data sudah diperbarui. Pilih menu untuk melihat.</div>`;
});

/* -------------------------
   EL Button (foto overlay)
   - This is purely visual, does not touch data
   ------------------------- */
btnEL.addEventListener("click", ()=>{
  resetMainButtons(); btnEL.classList.add("active");
  weekButtons.style.display = "none";
  // show small loader then photo
  dataDisplay.innerHTML = `<div class="card">Memuat foto ELâ€¦</div>`;
  setTimeout(()=>{
    dataDisplay.innerHTML = `<div class="card"><strong>KEPO MAKSIMAL</strong><div style="margin-top:8px"><img src="https://drive.google.com/uc?export=view&id=19jwYKbL6ctT7FY8un4_pk3z4MmTkdeCJ" alt="EL" style="max-width:100%;border-radius:8px"></div><div style="margin-top:8px"><button class="btn" id="backHome">Back</button></div></div>`;
    document.getElementById("backHome").addEventListener("click", ()=>{
      resetMainButtons();
      dataDisplay.innerHTML = `<div class="card">Klik Weekly atau Monthly untuk mulai</div>`;
    });
  }, 800);
});

/* -------------------------
   INIT
   ------------------------- */
(async function init(){
  try{
    showLoader();
    await loadAll(); // loads master CSVs & optionally sheets
    hideLoader();
    dataDisplay.innerHTML = `<div class="card">Klik Weekly atau Monthly untuk mulai</div>`;
  }catch(e){
    hideLoader();
    console.error(e);
    dataDisplay.innerHTML = `<div class="card">Terjadi error saat memuat data. Cek console.</div>`;
  }
})();
</script>
</body>
</html>
