<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MONITORING GFORM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* ---------- Basic ---------- */
body{font-family:Calibri,Arial,Helvetica,sans-serif;background:#f0f2f6;margin:0;color:#222}
header{background:#1e5bb8;color:white;padding:15px;text-align:center;font-weight:700}
.wrap{padding:16px}

/* ---------- Controls ---------- */
.controls{display:flex;gap:10px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border:none;border-radius:8px;background:#1e5bb8;color:#fff;cursor:pointer;font-weight:700;transition:all .15s}
.btn:hover{transform:translateY(-2px)}
.btn.active{background:#d62828}

/* ---------- Week selector (initially hidden) ---------- */
#weekSelector{display:none;margin:12px 0;gap:10px;flex-wrap:wrap}
.week-btn{padding:8px 12px;border-radius:8px;background:#e7e9ee;border:2px solid transparent;cursor:pointer;font-weight:700}
.week-btn:hover{background:#e0e3ea}
.week-btn.active{background:#d62828;color:#fff;border-color:#b81f1f}

/* ---------- Weekly details (hidden until a week is chosen) ---------- */
#weeklyDetails{display:none;margin-top:12px}

/* ---------- Grid & cards ---------- */
.week-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06);min-height:120px;overflow:auto}
.card h4{text-align:center;margin:0 0 10px;font-size:14px;color:white;padding:6px;border-radius:6px;background:#1e5bb8;cursor:pointer;transition:.15s}
.card h4.active{background:#d62828}
.item{border-bottom:1px solid #f1f3f6;padding:6px 0;font-size:13px}
small{font-size:11px;color:#666}

/* ---------- Alternative single-column lists for selected week ---------- */
.single-list-wrap{display:flex;gap:12px;flex-wrap:wrap}
.single-list{flex:1;min-width:260px;background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-height:360px;overflow:auto}
.single-list h4{margin:0 0 8px;padding:6px;border-radius:6px;background:#1e5bb8;color:#fff}

/* ---------- Chart ---------- */
.chart-wrap{background:white;padding:12px;border-radius:10px;margin-top:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.chart-wrap canvas{max-width:420px}

/* responsive */
@media (max-width:900px){
  .week-grid{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:520px){
  .week-grid{grid-template-columns:1fr}
  .controls{gap:8px}
}
</style>
</head>

<body>
<header>MONITORING GFORM</header>

<div class="wrap">

  <div class="controls">
    <button class="btn" id="btnWeekly">WEEKLY</button>
    <button class="btn" id="btnMonthly">MONTHLY</button>
    <button class="btn" id="btnExport">EXPORT</button>
    <button class="btn" id="btnRefresh">REFRESH</button>
  </div>

  <!-- WEEK SELECTOR (tampil setelah klik WEEKLY) -->
  <div id="weekSelector" class="controls">
    <div class="week-btn" data-week="1">WEEK 1</div>
    <div class="week-btn" data-week="2">WEEK 2</div>
    <div class="week-btn" data-week="3">WEEK 3</div>
    <div class="week-btn" data-week="4">WEEK 4</div>
  </div>

  <!-- WEEKLY Dashboard (details for selected week) -->
  <div id="weeklyDetails">
    <h3 id="weeklyTitle">Data Weekly</h3>

    <!-- when a week is selected, we show two lists (sudah / belum) -->
    <div class="single-list-wrap">
      <div class="single-list">
        <h4 id="sudahHeader">Sudah Input</h4>
        <div id="sudahList"></div>
      </div>
      <div class="single-list">
        <h4 id="belumHeader">Belum Input</h4>
        <div id="belumList"></div>
      </div>
    </div>

    <div class="chart-wrap">
      <h4>Grafik Weekly</h4>
      <canvas id="chartWeekly"></canvas>
    </div>
  </div>

  <!-- MONTHLY (keadaan tetap sama seperti sebelumnya, muncul saat klik MONTHLY) -->
  <div id="monthlyDashboard" style="display:none">
    <h3>Sudah Input Monthly</h3>
    <div class="week-grid" id="monthlySudah"></div>

    <h3 style="margin-top:20px">Belum Input Monthly</h3>
    <div class="week-grid" id="monthlyBelum"></div>

    <div class="chart-wrap">
      <h4>Grafik Monthly</h4>
      <canvas id="chartMonthly"></canvas>
    </div>
  </div>

</div>

<script>
/* =======================
   Data URLs (tidak diubah)
   ======================= */
const MASTER_CSV = "Data Mesin.csv";
const WEEKLY_SHEET_ID = "19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck";
const WEEKLY_SHEET_NAME = "Form Responses 1";
const WEEKLY_SHEET_URL = `https://opensheet.elk.sh/${WEEKLY_SHEET_ID}/${encodeURIComponent(WEEKLY_SHEET_NAME)}`;
const MONTHLY_SHEET_URL = "https://docs.google.com/spreadsheets/d/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/export?format=csv&gid=1674075217`".replace(/`$/,""); // keep original format (safe fallback)

/* =======================
   Utilities & state
   ======================= */
function safe(v){ return v==null ? "" : String(v).trim(); }
function parseWeek(raw){
  const m = String(raw).match(/(\d)/);
  const n = m ? parseInt(m[1],10) : 1;
  return (n>=1 && n<=4) ? n : 1;
}
async function loadCSV(url){
  return new Promise(resolve=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
      complete:r=>resolve(r.data), error:()=>resolve([])});
  });
}

let masterList = [], weeklyRows = [], monthlyRows = [];
let chartWeekly = null, chartMonthly = null;
let selectedWeek = null; // <-- which week the user clicked (1..4)

/* =======================
   Load all data (same logic as original)
   ======================= */
async function loadAll(){
  try {
    masterList = await loadCSV(MASTER_CSV);
  } catch(e){ masterList = []; }
  try {
    weeklyRows = await fetch(WEEKLY_SHEET_URL).then(r=>r.json()).catch(()=>[]);
  } catch(e){ weeklyRows = []; }
  try {
    monthlyRows = await loadCSV(MONTHLY_SHEET_URL);
  } catch(e){ monthlyRows = []; }

  // If a week is already selected, refresh its rendering
  if(selectedWeek) renderWeeklyForWeek(selectedWeek);
  // always update monthly lists (they're independent)
  renderMonthly();
}

/* =======================
   Render for a specific week (only when a week is clicked)
   ======================= */
function renderWeeklyForWeek(w){
  // build lists for that week
  const sudahList = [];
  const belumList = [];
  const sektorCount = {};

  const masterW = masterList.filter(m=>parseWeek(m.WEEK)===w);
  for(const m of masterW){
    const id = safe(m["ID Mesin"]);
    const sektor = safe(m.SEKTOR)||"—";
    const nama = safe(m["Nama Lokasi"])||"—";
    const match = weeklyRows.find(r=> safe(r["ID Mesin"])===id && parseWeek(r.WEEK)===w );

    if(match){
      sudahList.push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}<br><small>${match.Timestamp||''}</small></div>`);
      sektorCount[sektor] = (sektorCount[sektor]||0)+1;
    } else {
      belumList.push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}</div>`);
    }
  }

  document.getElementById("sudahList").innerHTML = sudahList.join("") || "<i>Tidak ada</i>";
  document.getElementById("belumList").innerHTML = belumList.join("") || "<i>Tidak ada</i>";
  document.getElementById("weeklyTitle").innerText = `Data Weekly — WEEK ${w}`;
  document.getElementById("sudahHeader").innerText = `Sudah Input (WEEK ${w})`;
  document.getElementById("belumHeader").innerText = `Belum Input (WEEK ${w})`;

  // PIE CHART (for selected week)
  const labels = Object.keys(sektorCount);
  const counts = labels.map(l=>sektorCount[l]);
  const ctx = document.getElementById("chartWeekly").getContext("2d");

  if(chartWeekly) chartWeekly.destroy();
  chartWeekly = new Chart(ctx,{
    type:"pie",
    data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},
    options:{responsive:true, maintainAspectRatio:false}
  });
}

/* =======================
   MONTHLY render (keamanan: tidak diubah logic)
   ======================= */
function renderMonthly(){
  const sudah=[], belum=[], sektorCount={};

  for(const m of masterList){
    const id = safe(m["ID Mesin"]);
    const sektor = safe(m.SEKTOR)||"—";
    const nama = safe(m["Nama Lokasi"])||"—";

    const match = monthlyRows.find(r=>safe(r["ID Mesin"])===id);

    if(match){
      sudah.push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}<br><small>${match.Timestamp||''}</small></div>`);
      sektorCount[sektor]=(sektorCount[sektor]||0)+1;
    } else {
      belum.push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}</div>`);
    }
  }

  // Bagi 4 kolom (tetap seperti original)
  const ms=document.getElementById("monthlySudah");
  const mb=document.getElementById("monthlyBelum");
  ms.innerHTML=""; mb.innerHTML="";

  for(let col=0; col<4; col++){
    const divS=document.createElement("div");
    divS.className="card";
    divS.innerHTML = sudah.filter((_,i)=>i%4===col).join("") || "<i>Tidak ada</i>";
    ms.appendChild(divS);

    const divB=document.createElement("div");
    divB.className="card";
    divB.innerHTML = belum.filter((_,i)=>i%4===col).join("") || "<i>Tidak ada</i>";
    mb.appendChild(divB);
  }

  const labels = Object.keys(sektorCount);
  const counts = labels.map(l=>sektorCount[l]);

  const ctx = document.getElementById("chartMonthly").getContext("2d");
  if(chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(ctx,{
    type:"pie",
    data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},
    options:{responsive:true, maintainAspectRatio:false}
  });
}

/* =======================
   UI interactions (preserve original button behavior & add new flows)
   ======================= */

// Helper: set active main button (WEEKLY / MONTHLY)
function setActiveMode(mode){
  document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn'+mode).classList.add('active');
}

// Initially: show only header + controls (nothing else)
// WEEKLY button: show week selector (but not the data until a week clicked)
document.getElementById("btnWeekly").onclick = ()=>{
  document.getElementById("monthlyDashboard").style.display="none";
  document.getElementById("weekSelector").style.display="flex";
  document.getElementById("weeklyDetails").style.display = selectedWeek ? "block" : "none";
  setActiveMode('Weekly');
};

// MONTHLY button: show monthly dashboard, hide weekly selector/details
document.getElementById("btnMonthly").onclick = ()=>{
  document.getElementById("monthlyDashboard").style.display="block";
  document.getElementById("weekSelector").style.display="none";
  document.getElementById("weeklyDetails").style.display = "none";
  setActiveMode('Monthly');
};

// REFRESH re-load data
document.getElementById("btnRefresh").onclick = ()=> loadAll();

// EXPORT (sama logic seperti original)
document.getElementById("btnExport").onclick = ()=>{
  const rows=[];
  for(const m of masterList){
    const id=safe(m["ID Mesin"]);
    const nama=safe(m["Nama Lokasi"]);
    const sektor=safe(m.SEKTOR)||"—";
    const weeklyMatch=weeklyRows.find(r=>safe(r["ID Mesin"])===id);
    const monthlyMatch=monthlyRows.find(r=>safe(r["ID Mesin"])===id);

    rows.push({
      ID:id,
      Nama_Lokasi:nama,
      Sektor:sektor,
      Weekly: weeklyMatch? weeklyMatch.Timestamp : "—",
      Monthly: monthlyMatch? monthlyMatch.Timestamp : "—"
    });
  }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Monitoring");
  XLSX.writeFile(wb,"Monitoring.xlsx");
};

/* =======================
   Week selector logic (appear after btnWeekly)
   ======================= */
const weekButtons = document.querySelectorAll('.week-btn');
weekButtons.forEach(b=>{
  b.addEventListener('click', ()=>{
    weekButtons.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    selectedWeek = parseInt(b.getAttribute('data-week'), 10);

    // Show weekly details and render data for that week
    document.getElementById("weeklyDetails").style.display = "block";
    renderWeeklyForWeek(selectedWeek);
  });
});

/* =======================
   Card header clickable highlight (just visual)
   ======================= */
document.addEventListener('click', function(e){
  if(e.target.matches('.card h4')){
    document.querySelectorAll('.card h4').forEach(h=>h.classList.remove('active'));
    e.target.classList.add('active');
  }
});

/* =======================
   Start
   ======================= */
loadAll();
// keep periodic refresh (same as original)
setInterval(loadAll, 600000);
</script>
</body>
</html>
