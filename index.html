<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MONITORING GFORM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Calibri,Arial;background:#f5f7fa;margin:0;color:#222}
header{background:#1e5bb8;color:white;padding:15px;text-align:center;font-weight:700}
.wrap{padding:16px}
.controls{display:flex;gap:10px;margin-bottom:12px}
.btn{padding:8px 12px;border:none;border-radius:6px;background:#1e5bb8;color:#fff;cursor:pointer}
.week-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:white;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-height:120px}
.card h4{text-align:center;margin:0 0 8px;font-size:14px;color:black;background:#eaeaea;padding:4px;border-radius:4px}
.item{border-bottom:1px solid #eee;padding:4px 0;font-size:13px}
small{font-size:11px;color:#666}
.chart-wrap{background:white;padding:10px;border-radius:8px;margin-top:14px;text-align:center}
.chart-wrap canvas{transform:scale(0.6);transform-origin:top}
</style>
</head>

<body>
<header>MONITORING GFORM</header>

<div class="wrap">

  <div class="controls">
    <button class="btn" id="btnWeekly">WEEKLY</button>
    <button class="btn" id="btnMonthly">MONTHLY</button>
    <button class="btn" id="btnExport">EXPORT</button>
    <button class="btn" id="btnRefresh">REFRESH</button>
  </div>

  <!-- WEEKLY -->
  <div id="weeklyDashboard">
    <h3>Sudah Input Weekly</h3>
    <div class="week-grid">
      <div class="card"><h4>W1</h4><div id="sudahW1"></div></div>
      <div class="card"><h4>W2</h4><div id="sudahW2"></div></div>
      <div class="card"><h4>W3</h4><div id="sudahW3"></div></div>
      <div class="card"><h4>W4</h4><div id="sudahW4"></div></div>
    </div>

    <h3>Belum Input Weekly</h3>
    <div class="week-grid">
      <div class="card"><h4>W1</h4><div id="belumW1"></div></div>
      <div class="card"><h4>W2</h4><div id="belumW2"></div></div>
      <div class="card"><h4>W3</h4><div id="belumW3"></div></div>
      <div class="card"><h4>W4</h4><div id="belumW4"></div></div>
    </div>

    <div class="chart-wrap">
      <h4>Grafik Weekly</h4>
      <canvas id="chartWeekly"></canvas>
    </div>
  </div>

  <!-- MONTHLY -->
  <div id="monthlyDashboard" style="display:none">
    <h3>Sudah Input Monthly</h3>
    <div class="week-grid" id="monthlySudah"></div>

    <h3>Belum Input Monthly</h3>
    <div class="week-grid" id="monthlyBelum"></div>

    <div class="chart-wrap">
      <h4>Grafik Monthly</h4>
      <canvas id="chartMonthly"></canvas>
    </div>
  </div>

</div>

<script>
// =======================
// URL DATA FIX
// =======================
const MASTER_CSV = "Data Mesin.csv";
const MASTER_MONTHLY_CSV = "Data Mesin Monthly.csv";  // ← CSV baru khusus monthly

const WEEKLY_SHEET_ID = "19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck";
const WEEKLY_SHEET_NAME = "Form Responses 1";
const WEEKLY_SHEET_URL = `https://opensheet.elk.sh/${WEEKLY_SHEET_ID}/${encodeURIComponent(WEEKLY_SHEET_NAME)}`;

const MONTHLY_SHEET_URL = "https://docs.google.com/spreadsheets/d/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/export?format=csv&gid=1674075217";

let masterList = [];
let monthlyRows = [];
// =======================
// UTILITIES
// =======================
function safe(v){ return v==null ? "" : String(v).trim(); }

function parseWeek(raw){
  const m = String(raw).match(/(\d)/);
  const n = m ? parseInt(m[1],10) : 1;
  return (n>=1 && n<=4) ? n : 1;
}

async function loadCSV(url){
  return new Promise(resolve=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
      complete:r=>resolve(r.data), error:()=>resolve([])});
  });
}

// =======================
// GLOBAL STATE
// =======================
let masterList = [], weeklyRows = [], monthlyRows = [];
let chartWeekly = null, chartMonthly = null;

// =======================
// LOAD ALL
// =======================
/* ------------------------------------------------------
   LOAD MONTHLY MASTER CSV (100 mesin saja)
-------------------------------------------------------*/
function loadMonthly() {
    document.getElementById("status").innerHTML = "Loading data…";

    Papa.parse(MASTER_MONTHLY_CSV, {
        download: true,
        header: true,
        complete: function (res) {
            masterList = res.data.filter(r => r["MACHINE ID"]);

            Papa.parse(MONTHLY_FORM_URL, {
                download: true,
                header: true,
                complete: function (res2) {
                    monthlyRows = res2.data;
                    renderMonthly();
                }
            });
        }
    });
}  
async function loadAll(){
  masterList = await loadCSV(MASTER_CSV);
  weeklyRows = await fetch(WEEKLY_SHEET_URL).then(r=>r.json()).catch(()=>[]);
  const rawMonthly = await loadCSV(MONTHLY_SHEET_URL);
monthlyRows = getLatestPerID(rawMonthly);
console.log("Monthly deduped:", rawMonthly.length, "→", monthlyRows.length);


  renderWeekly();
  renderMonthly();
}

// =======================
// WEEKLY RENDER
// =======================
function renderWeekly(){
  const sudah={1:[],2:[],3:[],4:[]};
  const belum={1:[],2:[],3:[],4:[]};
  const sektorCount={};

  for(let w=1;w<=4;w++){
    const masterW = masterList.filter(m=>parseWeek(m.WEEK)===w);
    for(const m of masterW){
      const id = safe(m["ID Mesin"]);
      const sektor = safe(m.SEKTOR)||"—";
      const nama = safe(m["Nama Lokasi"])||"—";

      const match = weeklyRows.find(r=> safe(r["ID Mesin"])===id && parseWeek(r.WEEK)===w );

      if(match){
        sudah[w].push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}<br><small>${match.Timestamp}</small></div>`);
        sektorCount[sektor] = (sektorCount[sektor]||0)+1;
      } else {
        belum[w].push(`<div class='item'><strong>${id}</strong> — ${sektor}<br>${nama}</div>`);
      }
    }
    document.getElementById("sudahW"+w).innerHTML = sudah[w].join("") || "<i>Tidak ada</i>";
    document.getElementById("belumW"+w).innerHTML = belum[w].join("") || "<i>Tidak ada</i>";
  }

  // PIE CHART
  const labels = Object.keys(sektorCount);
  const counts = labels.map(l=>sektorCount[l]);
  const ctx = document.getElementById("chartWeekly").getContext("2d");

  if(chartWeekly) chartWeekly.destroy();
  chartWeekly = new Chart(ctx,{
    type:"pie",
    data:{labels:labels.length?labels:["No Data"],datasets:[{data:counts.length?counts:[1]}]},
    options:{responsive:false}
  });
}

// =======================
// MONTHLY RENDER
// =======================
function getLatestPerID(rows){
  const map = {};
  for(const r of rows){
    const id = safe(r["ID Mesin"]);
    if(!id) continue;

    const ts = new Date(safe(r.Timestamp) || "1970-01-01").getTime();

    if(!map[id] || ts > map[id].ts){
      map[id] = { ...r, ts };
    }
  }
  return Object.values(map);
}

/* ------------------------------------------------------
   RENDER MONTHLY — SPLIT PASTI 4 KOLOM (25/25/25/25)
-------------------------------------------------------*/
function renderMonthly() {

    const sudah = [];
    const belum = [];

    // proses setiap mesin master
    masterList.forEach(m => {
        const id = (m["MACHINE ID"] || "").trim();

        const found = monthlyRows.find(r => (r["MACHINE ID"] || "").trim() === id);

        if (found) {
            sudah.push(id);
        } else {
            belum.push(id);
        }
    });

    // pastikan jumlah tetap konsisten (100 mesin)
    const chunk = arr => {
        const size = Math.ceil(arr.length / 4);
        return [
            arr.slice(0, size),
            arr.slice(size, size * 2),
            arr.slice(size * 2, size * 3),
            arr.slice(size * 3, size * 4)
        ];
    };

    const colsSudah = chunk(sudah);
    const colsBelum = chunk(belum);

    // render helper
    const fill = (id, list) => {
        document.getElementById(id).innerHTML = list
            .map(i => `<div class="item">${i}</div>`).join("");
    };

    fill("col1_sudah", colsSudah[0]);
    fill("col2_sudah", colsSudah[1]);
    fill("col3_sudah", colsSudah[2]);
    fill("col4_sudah", colsSudah[3]);

    fill("col1_belum", colsBelum[0]);
    fill("col2_belum", colsBelum[1]);
    fill("col3_belum", colsBelum[2]);
    fill("col4_belum", colsBelum[3]);

    document.getElementById("status").innerHTML =
        `SUDAH: ${sudah.length} • BELUM: ${belum.length}`;
}
  // PIE CHART update (monthly)
  const labels = Object.keys(sektorCount);
  const counts = labels.map(l => sektorCount[l]);
  const ctx = document.getElementById("chartMonthly") && document.getElementById("chartMonthly").getContext("2d");
  if(!ctx){
    console.warn("chartMonthly canvas not found");
    return;
  }
  if(chartMonthly) try{ chartMonthly.destroy(); }catch(e){/*ignore*/}

  chartMonthly = new Chart(ctx,{
    type: "pie",
    data: { labels: labels.length ? labels : ["No Data"], datasets: [{ data: counts.length ? counts : [1] }] },
    options: { responsive: false }
  });

  console.log("renderMonthly() DONE");
}


// =======================
// BUTTONS
// =======================
document.getElementById("btnWeekly").onclick = ()=>{
  weeklyDashboard.style.display="block";
  monthlyDashboard.style.display="none";
};

document.getElementById("btnMonthly").onclick = ()=>{
  weeklyDashboard.style.display="none";
  monthlyDashboard.style.display="block";
};

document.getElementById("btnRefresh").onclick = ()=>loadAll();

// EXPORT
document.getElementById("btnExport").onclick = ()=>{
  const rows=[];
  for(const m of masterList){
    const id=safe(m["ID Mesin"]);
    const nama=safe(m["Nama Lokasi"]);
    const sektor=safe(m.SEKTOR)||"—";
    const weeklyMatch=weeklyRows.find(r=>safe(r["ID Mesin"])===id);
    const monthlyMatch=monthlyRows.find(r=>safe(r["ID Mesin"])===id);

    rows.push({
      ID:id,
      Nama_Lokasi:nama,
      Sektor:sektor,
      Weekly: weeklyMatch? weeklyMatch.Timestamp : "—",
      Monthly: monthlyMatch? monthlyMatch.Timestamp : "—"
    });
  }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Monitoring");
  XLSX.writeFile(wb,"Monitoring.xlsx");
};

loadAll();
setInterval(loadAll, 600000);
</script>
</body>
</html>




