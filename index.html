<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MONITORING GFORM</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f7fa; color:#222; }
header { background:#1e5bb8; color:white; padding:15px; text-align:center; font-size:20px; font-weight:bold; position:fixed; top:0; left:0; right:0; z-index:1000; }
.wrap { padding:16px; padding-top:90px; /* space for fixed header + buttons */ }
.button-row { display:flex; gap:10px; margin-bottom:12px; position:fixed; top:60px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:999; }
.btn { padding:8px 16px; border:none; border-radius:6px; background:#1e5bb8; color:white; cursor:pointer; font-weight:bold; }
.btn.active { background:red; }
.week-row { display:flex; gap:8px; margin-bottom:12px; display:none; position:fixed; top:105px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:998; }
.week-btn { padding:6px 12px; border:none; border-radius:6px; background:#666; color:white; cursor:pointer; font-weight:bold; }
.week-btn.active { background:red; }
#dataDisplay { margin-top:150px; overflow-y:auto; max-height:calc(100vh - 150px); padding-bottom:20px; }
.card { background:white; padding:10px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.week-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.item { border-bottom:1px solid #eee; padding:4px 0; font-size:13px; }
.chart-wrap { background:white; padding:10px; border-radius:8px; margin-top:14px; text-align:center;width: 400px;        /* ganti sesuai keinginan */
  height: 400px;       /* ganti sesuai keinginan */
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin: 20px auto;   /* top-center */
  text-align: center;
  position: relative;  /* penting supaya Chart.js responsive */ }
.chart-wrap canvas {  transform-origin:top:center; width: 100% !important;
  height: 100% !important; }
.card.sudah { background:#d4edda; }   /* hijau muda */
.card.belum { background:#f8d7da; }  /* merah muda */
.card h4 { margin:0 0 8px; font-size:14px; color:black; background:#eaeaea; padding:4px; border-radius:4px; }
.item { border-bottom:1px solid #eee; padding:4px 0; font-size:13px; }
.card {
  border-radius:8px;
  padding:6px;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.card.sudah { background:#d4edda; }
.card.belum { background:#f8d7da; }

.item {
  border-bottom:1px solid #eee;
  padding:4px 0;
  font-size:13px;
  position: relative;
  cursor: default;
  transition: background 0.15s ease, padding-left 0.15s ease;
}
.item:hover { background: rgba(0,0,0,0.05); padding-left:4px; }

/* Tooltip */
.item .tooltip {
  visibility: hidden;
  color: #fff;
  text-align: center;
  border-radius: 4px;
  padding: 2px 6px;
  position: absolute;
  z-index: 10;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.15s ease;
}
.card.sudah .tooltip { background: #28a745; }
.card.belum .tooltip { background: #dc3545; }
.item .tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
}
.card.sudah .tooltip::after { border-color: #28a745 transparent transparent transparent; }
.card.belum .tooltip::after { border-color: #dc3545 transparent transparent transparent; }
.item:hover .tooltip { visibility: visible; opacity: 1; }

.card.sudah { background:#d4edda; }
.card.belum { background:#f8d7da; }
.item { border-bottom:1px solid #eee; padding:6px 4px; font-size:13px; position:relative; transition: background .12s; }
.item:hover{ background: rgba(0,0,0,0.04); padding-left:4px; }
.item .tooltip{ visibility:hidden; opacity:0; transition:opacity .12s; position:absolute; bottom:125%; left:50%; transform:translateX(-50%); white-space:nowrap; padding:4px 6px; color:#fff; border-radius:4px; font-size:11px; z-index:10; }
.card.sudah .tooltip{ background:#28a745; }
.card.belum .tooltip{ background:#dc3545; }
.item:hover .tooltip{ visibility:visible; opacity:1; }
.chart-wrap{ width:400px; height:360px; margin:18px auto; position:relative; text-align:center; background:white; padding:10px; border-radius:8px; }
.chart-wrap canvas{ width:100% !important; height:100% !important; }
/* === Monthly Purple Pastel === */
.monthly-card.sudah {
  background: #e9d8fd;  /* ungu pastel muda */
  border: 1px solid #d6bcfa;
}

.monthly-card.belum {
  background: #f3e8ff; /* ungu pastel lebih soft */
  border: 1px solid #e9d5ff;
}

/* Hover biar tetap smooth */
.monthly-card .item:hover {
  background: rgba(120, 80, 200, 0.08);
}
/* ===== Efek Nimbul untuk Header Bar ===== */
.header-bar {
    transition: 0.25s ease;
}
.header-bar:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ===== Efek Nimbul untuk Semua Card ===== */
.card {
    transition: 0.25s ease;
}
.card:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}  
/* ===== Hover & shadow untuk semua card ===== */
.card, .monthly-card {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.card:hover, .monthly-card:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

/* ===== Hover & shadow untuk header ===== */
header {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}
header:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ===== Tooltip text biru untuk monthly ===== */
.monthly-card .tooltip {
    color: #0d6efd; /* biru kontras */
    background: #e0e0e0; /* bisa diganti sesuai selera, biar teks jelas */
}

/* ===== Hover & shadow untuk semua tombol ===== */
.button-row .btn, .week-row .week-btn, .el-btn {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.button-row .btn:hover, .week-row .week-btn:hover, .el-btn:hover {
    transform: translateY(-2px) scale(1.08);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

</style>
</head>
<body>

<header>MONITORING GFORM</header>

<div class="wrap">
  <div class="controls">
    <!-- Buttons -->
  <div class="button-row">
    <button class="btn" id="btnWeekly">Weekly</button>
    <button class="btn" id="btnMonthly">Monthly</button>
    <button class="btn" id="btnExport">Export</button>
    <button class="btn" id="btnRefresh">Refresh</button>

    <button id="btnEL" class="el-btn">EL</button> <!-- tombol baru -->
  </div>

  <!-- Weekly week buttons -->
  <div class="week-row" id="weekButtons">
    <button class="week-btn" data-week="1">W1</button>
    <button class="week-btn" data-week="2">W2</button>
    <button class="week-btn" data-week="3">W3</button>
    <button class="week-btn" data-week="4">W4</button>
    <div style="margin-left:8px;color:#666;font-size:13px">Auto-refresh 10 menit — shows Timestamp, ID Mesin, Nama Lokasi, WEEK, SEKTOR</div>
  </div>
<!-- Data Display -->
  <div id="dataDisplay"></div>
  <div class="week-grid">
    <div class="card" id="cardW1"><h4>WEEK 1</h4><div id="sudahW1">—</div><div id="countSW1" style="margin-top:8px"></div></div>
    <div class="card" id="cardW2"><h4>WEEK 2</h4><div id="sudahW2">—</div><div id="countSW2" style="margin-top:8px"></div></div>
    <div class="card" id="cardW3"><h4>WEEK 3</h4><div id="sudahW3">—</div><div id="countSW3" style="margin-top:8px"></div></div>
    <div class="card" id="cardW4"><h4>WEEK 4</h4><div id="sudahW4">—</div><div id="countSW4" style="margin-top:8px"></div></div>
  </div>

  <h3 style="margin-top:18px">Belum Terinput</h3>
  <div class="week-grid" style="margin-bottom:18px">
    <div class="card week1"><h4>W1</h4><div id="belumW1">—</div><div id="countBW1"></div></div>
    <div class="card week2"><h4>W2</h4><div id="belumW2">—</div><div id="countBW2"></div></div>
    <div class="card week3"><h4>W3</h4><div id="belumW3">—</div><div id="countBW3"></div></div>
    <div class="card week4"><h4>W4</h4><div id="belumW4">—</div><div id="countBW4"></div></div>
  </div>

  <div id="chartWrap" style="background:#fff;padding:12px;border-radius:8px; width:100%; text-align:center;">
  <h4>Grafik per SEKTOR</h4>
  <div style="display:inline-block; transform: scale(1.8); transform-origin: top center;">
    <canvas id="chartSektor"></canvas>
  </div>
</div>

<script>
// ------------------
// State
// ------------------
const btnWeekly = document.getElementById("btnWeekly");
const btnMonthly = document.getElementById("btnMonthly");
const btnExport = document.getElementById("btnExport");
const btnRefresh = document.getElementById("btnRefresh");
const weekButtons = document.getElementById("weekButtons");
const weekBtns = document.querySelectorAll(".week-btn");
const dataDisplay = document.getElementById("dataDisplay");

function resetMainButtons() { [btnWeekly, btnMonthly, btnExport, btnRefresh].forEach(b=>b.classList.remove("active")); }
function resetWeekButtons() { weekBtns.forEach(b=>b.classList.remove("active")); }

const MASTER_WEEKLY_CSV = "Data Mesin.csv"; 
const MASTER_MONTHLY_CSV = "Data Mesin Monthly.csv"; 
const WEEKLY_SHEET_ID = "19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck";
const WEEKLY_SHEET_NAME = "Form Responses 1";
const WEEKLY_SHEET_URL = `https://opensheet.elk.sh/${WEEKLY_SHEET_ID}/${encodeURIComponent(WEEKLY_SHEET_NAME)}`;

const MONTHLY_FORM_URL = "https://opensheet.elk.sh/19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck/Form%20Responses%201";

function getCol(obj,name){
  if(!obj) return "";
  const target = name.toLowerCase().trim();
  for(const k in obj) if(k.toLowerCase().trim()===target) return obj[k];
  return "";
}
function safe(v){ return v==null?"":String(v).trim();}
function parseWeek(raw){ const m=String(raw).match(/(\d)/); const n=m?parseInt(m[1],10):1; return (n>=1&&n<=4)?n:1;}

let masterList=[], formRows=[], chart=null;

async function loadMaster(){
  return new Promise(resolve=>{
    Papa.parse(MASTER_CSV,{download:true,header:true,skipEmptyLines:true,
      complete:r=>{ masterList = Array.isArray(r.data)? r.data.filter(x=>safe(getCol(x,"ID Mesin"))!=="") : []; console.log("master count:", masterList.length); resolve(); },
      error:e=>{ console.warn("failed load master:",e); masterList=[]; resolve(); }
    });
  });
}

async function loadForm(){
  try{
    const res = await fetch(FORM_URL,{cache:"no-store"});
    formRows = await res.json();
    if(!Array.isArray(formRows)) formRows=[];
    console.log("form rows:",formRows.length);
  }catch(e){ console.error("failed fetch form:",e); formRows=[]; }
}

function render(){
  const sudah={1:[],2:[],3:[],4:[]};
  const belum={1:[],2:[],3:[],4:[]};
  const sektorCount={};

  for(let w=1; w<=4; w++){
    const masterThisWeek = masterList.filter(m=>parseWeek(getCol(m,"WEEK"))===w);
    for(const m of masterThisWeek){
      const id = safe(getCol(m,"ID Mesin"));
      const sektorMaster = safe(getCol(m,"SEKTOR"))||"—";
      const namaLokasiMaster = safe(getCol(m,"Nama Lokasi"))||"—";

      const match = formRows.find(r=>safe(getCol(r,"ID Mesin"))===id && parseWeek(getCol(r,"WEEK"))===w);

      if(match){
        sudah[w].push({
          id,
          sektor: sektorMaster,
          namaLokasi: safe(getCol(match,"Nama Lokasi"))||namaLokasiMaster,
          timestamp: safe(getCol(match,"Timestamp"))||"—",
          week:`Week ${w}`
        });
        sektorCount[sektorMaster]=(sektorCount[sektorMaster]||0)+1;
      }else{
        belum[w].push({
          id,
          sektor: sektorMaster,
          namaLokasi: namaLokasiMaster,
          timestamp:"—",
          week:`Week ${w}`
        });
      }
    }
  }

  for(let w=1; w<=4; w++){
    document.getElementById("sudahW"+w).innerHTML = sudah[w].length
      ? sudah[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}<br><small>${it.week} • ${it.timestamp}</small></div>`).join("")
      : "<i>Tidak ada data</i>";
    document.getElementById("belumW"+w).innerHTML = belum[w].length
      ? belum[w].map(it=>`<div class="item"><strong>${it.id}</strong> — ${it.sektor}<br>${it.namaLokasi}</div>`).join("")
      : "<i>Semua mesin terinput</i>";
    document.getElementById("countSW"+w).innerText = `Total: ${sudah[w].length} mesin`;
    document.getElementById("countBW"+w).innerText = `Total: ${belum[w].length} mesin`;
  }

  const labels = Object.keys(sektorCount);
  const counts = labels.map(l=>sektorCount[l]);
  const ctx = document.getElementById("chartSektor").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"pie",
    data:{labels: labels.length?labels:["No Data"], datasets:[{data: counts.length?counts:[1]}]},
    options:{responsive:false}
  });

  console.log("render done counts:",{sudah1:sudah[1].length,sudah2:sudah[2].length,sudah3:sudah[3].length,sudah4:sudah[4].length});
}

document.getElementById("btnRefresh").addEventListener("click",()=>loadAll());
document.getElementById("btnExport").addEventListener("click",()=>{
  const rows=[];
  for(let w=1; w<=4; w++){
    const masterThisWeek = masterList.filter(m=>parseWeek(getCol(m,"WEEK"))===w);
    for(const m of masterThisWeek){
      const id = safe(getCol(m,"ID Mesin"));
      const sektorMaster = safe(getCol(m,"SEKTOR"))||"—";
      const namaLokasiMaster = safe(getCol(m,"Nama Lokasi"))||"—";
      const match = formRows.find(r=>safe(getCol(r,"ID Mesin"))===id && parseWeek(getCol(r,"WEEK"))===w);
      if(match){
        rows.push({Timestamp:safe(getCol(match,"Timestamp"))||"—",ID_Mesin:id,Nama_Lokasi:safe(getCol(match,"Nama Lokasi"))||namaLokasiMaster,WEEK:`Week ${w}`,SEKTOR:sektorMaster});
      }else{
        rows.push({Timestamp:"—",ID_Mesin:id,Nama_Lokasi:namaLokasiMaster,WEEK:`Week ${w}`,SEKTOR:sektorMaster});
      }
    }
  }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Monitoring");
  XLSX.writeFile(wb,`Monitoring_${new Date().toISOString().slice(0,10)}.xlsx`);
});

async function loadAll(){
  await loadMaster();
  await loadForm();
  render();
}

loadAll();
setInterval(loadAll,600000);
</script>

</body>
</html>













