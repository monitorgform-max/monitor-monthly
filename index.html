<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MONITORING GFORM</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* ===== CSS ===== */
body { font-family: Arial, sans-serif; margin:0; background:#f5f7fa; color:#222; }
header { background:#1e5bb8; color:white; padding:15px; text-align:center; font-size:20px; font-weight:bold; position:fixed; top:0; left:0; right:0; z-index:1000; transition: transform 0.25s ease, box-shadow 0.25s ease;}
header:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
.wrap { padding:16px; padding-top:90px; }
.button-row { display:flex; gap:10px; margin-bottom:12px; position:fixed; top:60px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:999; }
.btn { padding:8px 16px; border:none; border-radius:6px; background:#1e5bb8; color:white; cursor:pointer; font-weight:bold; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.btn.active { background:red; }
.btn:hover { transform: translateY(-2px) scale(1.08); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
.el-btn { position: relative; padding: 8px 16px; border: none; border-radius: 6px; background: #1e5bb8; color: white; cursor: pointer; font-weight: bold; font-size: 16px; transition: transform 0.2s ease, box-shadow 0.2s ease; overflow: hidden; z-index: 0; text-transform: uppercase; letter-spacing: 1px; }
.el-btn:hover { transform: translateY(-2px) scale(1.08); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.el-btn::before { content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 6px; background: linear-gradient(270deg, #0ff, #00f, #0ff, #00f); background-size: 400% 400%; filter: blur(6px); opacity: 0.6; z-index: -1; transition: opacity 0.3s ease; animation: elGlowAnim 3s ease infinite; }
.el-btn:hover::before { opacity: 1; filter: blur(10px); }
.el-btn.active::before { opacity: 1; filter: blur(8px); animation: elGlowAnim 1.5s ease infinite; }
@keyframes elGlowAnim { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
.week-row { display:flex; gap:8px; margin-bottom:12px; display:none; position:fixed; top:105px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:998; }
.week-btn { padding:6px 12px; border:none; border-radius:6px; background:#666; color:white; cursor:pointer; font-weight:bold; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.week-btn.active { background:red; }
.week-btn:hover { transform: translateY(-2px) scale(1.08); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
#dataDisplay { margin-top:150px; overflow-y:auto; max-height:calc(100vh - 150px); padding-bottom:20px; }
.card, .monthly-card { border-radius:8px; padding:6px; transition: transform 0.25s ease, box-shadow 0.25s ease; }
.card:hover, .monthly-card:hover { transform: translateY(-3px) scale(1.03); box-shadow:0 6px 16px rgba(0,0,0,0.18); }
.card.sudah { background:#d4edda; }
.card.belum { background:#f8d7da; }
.monthly-card.sudah { background:#e9d8fd; border:1px solid #d6bcfa; }
.monthly-card.belum { background:#f3e8ff; border:1px solid #e9d5ff; }
.item { border-bottom:1px solid #eee; padding:6px 4px; font-size:13px; position:relative; cursor:default; transition: background 0.12s, padding-left 0.12s; }
.item:hover { background: rgba(0,0,0,0.04); padding-left:4px; }
.item .tooltip{ visibility:hidden; opacity:0; transition:opacity .12s; position:absolute; bottom:125%; left:50%; transform:translateX(-50%); white-space:nowrap; padding:4px 6px; color:#fff; border-radius:4px; font-size:11px; z-index:10; }
.card.sudah .tooltip{ background:#28a745; }
.card.belum .tooltip{ background:#dc3545; }
.monthly-card .tooltip{ color:#0d6efd; background:#e0e0e0; }
.item:hover .tooltip{ visibility:visible; opacity:1; }
.week-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.chart-wrap { width:400px; height:360px; margin:18px auto; position:relative; text-align:center; background:white; padding:10px; border-radius:8px; }
.chart-wrap canvas{ width:100% !important; height:100% !important; }
/* Loader */
#loader { position: fixed; inset: 0; background: radial-gradient(circle at 30% 30%, #0a0f1f, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #0ff; font-family: 'Orbitron', sans-serif; z-index: 9999; overflow: hidden; }
#loader h1 { font-size: 2.5em; margin-bottom: 0.5em; font-weight: 700; letter-spacing: 2px; color: #0ff; text-shadow: 0 0 10px #00f0ff, 0 0 20px #00cfff, 0 0 30px #0ff; animation: neonFlicker 1.2s infinite; }
#loader p { font-size: 1.2em; margin-bottom: 2em; color: #a2d3ff; opacity: 0.8; text-shadow: 0 0 6px #00cfff; }
.spinner { width: 80px; height: 80px; border: 6px solid rgba(0, 174, 255, 0.2); border-top: 6px solid #00cfff; border-right: 6px solid #0088ff; border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 20px #00cfff80; margin-bottom: 20px; }
.scan-line { position: absolute; width: 180%; height: 2px; background: linear-gradient(90deg,#00d4ff,#0094ff,#0060ff,#00d4ff); opacity: 0.4; }
.line1 { top: 30%; animation: scan 3s linear infinite; }
.line2 { bottom: 30%; transform: rotate(90deg); animation: scan 3s linear infinite; animation-delay: 1.5s; }
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes neonFlicker{0%,19%,21%,23%,25%,54%,56%,100%{opacity:1;text-shadow:0 0 6px #0ff,0 0 12px #0ff,0 0 18px #00d4ff;}20%,22%,24%,55%{opacity:0.4;text-shadow:none;}}
@keyframes scan{0%{transform:translateX(-50%) translateY(-200%);}100%{transform:translateX(-50%) translateY(200%);}}
</style>
</head>
<body>

<header>MONITORING GFORM</header>
<div class="wrap">
<div id="loader">
  <h1>LOADING......PLEASE WAIT....!!</h1>
  <p>Alloh bersama orang-orang sabar</p>
  <div class="spinner"></div>
  <div class="scan-line line1"></div>
  <div class="scan-line line2"></div>
</div>

<div class="button-row">
  <button class="btn" id="btnWeekly">Weekly</button>
  <button class="btn" id="btnMonthly">Monthly</button>
  <button class="btn" id="btnExport">Export</button>
  <button class="btn" id="btnRefresh">Refresh</button>
  <button id="btnEL" class="el-btn">EL ⚡</button>
</div>

<div class="week-row" id="weekButtons">
  <button class="week-btn" data-week="1">W1</button>
  <button class="week-btn" data-week="2">W2</button>
  <button class="week-btn" data-week="3">W3</button>
  <button class="week-btn" data-week="4">W4</button>
</div>

<div id="dataDisplay"></div>
</div>

<script>
const btnWeekly = document.getElementById("btnWeekly");
const btnMonthly = document.getElementById("btnMonthly");
const btnExport = document.getElementById("btnExport");
const btnRefresh = document.getElementById("btnRefresh");
const weekButtons = document.getElementById("weekButtons");
const weekBtns = document.querySelectorAll(".week-btn");
const dataDisplay = document.getElementById("dataDisplay");
const loader = document.getElementById("loader");
const btnEL = document.getElementById("btnEL");

function resetMainButtons(){ [btnWeekly,btnMonthly,btnExport,btnRefresh,btnEL].forEach(b=>b.classList.remove("active")); }
function resetWeekButtons(){ weekBtns.forEach(b=>b.classList.remove("active")); }

const MASTER_WEEKLY_CSV = "Data Mesin.csv"; 
const MASTER_MONTHLY_CSV = "Data Mesin Monthly.csv"; 
const WEEKLY_SHEET_URL = "https://opensheet.elk.sh/19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck/Form%20Responses%201";
const MONTHLY_FORM_URL = "https://opensheet.elk.sh/134suRLzzkA8d7G_I9k535R-hlA_IpYvV67MgTQ8HlKw/Form%20Responses%201";

let weeklyRows=[], monthlyRows=[], masterWeekly=[], masterMonthly=[];

function safe(v){ return v==null?"":String(v).trim(); }
async function loadCSV(url){ return new Promise(resolve=>{ Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:()=>resolve([])}); }); }

async function loadAll(){
  masterWeekly = await loadCSV(MASTER_WEEKLY_CSV);
  masterMonthly = await loadCSV(MASTER_MONTHLY_CSV);
  weeklyRows = await fetch(WEEKLY_SHEET_URL).then(r=>r.json()).catch(()=>[]);
  monthlyRows = await fetch(MONTHLY_FORM_URL).then(r=>r.json()).catch(()=>[]);
  console.log("Data loaded:", masterWeekly.length,"weekly,", masterMonthly.length,"monthly");
}

// --- Render Weekly ---
function renderWeekly(weekNumber){
  const targetWeek = `Week ${weekNumber}`;
  const list = masterWeekly.filter(m => safe(m.WEEK) === targetWeek);
  const sudahList=[], belumList=[];
  list.forEach(m=>{
    const id = safe(m["ID Mesin"]);
    const match = weeklyRows.find(r=>safe(r["ID Mesin"])===id && safe(r["WEEK"])===targetWeek);
    if(match) sudahList.push({...m, Timestamp:safe(match.Timestamp)}); else belumList.push(m);
  });
  function chunk(arr,n=4){ const out=Array.from({length:n},()=>[]); let idx=0,base=Math.floor(arr.length/n),rem=arr.length%n; for(let i=0;i<n;i++){const size=base+(i<rem?1:0); out[i]=arr.slice(idx,idx+size); idx+=size;} return out;}
  let html=`<h3>Sudah Input (${sudahList.length} mesin)</h3>` + chunk(sudahList).map(col=>`<div class="week-grid">`+col.map(m=>`<div class="card sudah"><div class="item"><strong>${safe(m["ID Mesin"])}</strong> — ${safe(m.SEKTOR)}<br>${safe(m["Nama Lokasi"])}<br><small>${m.Timestamp}</small><span class="tooltip">Timestamp: ${m.Timestamp}</span></div>`).join('')+`</div>`).join('')+`</div>`;
  html+=`<h3>Belum Input (${belumList.length} mesin)</h3>` + chunk(belumList).map(col=>`<div class="week-grid">`+col.map(m=>`<div class="card belum"><div class="item"><strong>${safe(m["ID Mesin"])}</strong> — ${safe(m.SEKTOR)}<br>${safe(m["Nama Lokasi"])}<span class="tooltip">Belum input</span></div>`).join('')+`</div>`).join('')+`</div>`;
  dataDisplay.innerHTML = html;
}

// --- Render Monthly ---
function renderMonthly(){
  const sudah=[], belum=[];
  masterMonthly.forEach(m=>{
    const id = safe(m["ID Mesin"]);
    const nama = safe(m["Nama Lokasi"])||"—";
    const sektor = safe(m.Sektor || m.SEKTOR)||"—";
    const match = monthlyRows.find(r=>safe(r["ID Mesin"])===id);
    if(match){
      let ts=safe(match.Timestamp); const d=new Date(ts); if(!isNaN(d)) ts=d.toLocaleString("id-ID",{hour12:false});
      sudah.push({id,nama,sektor,ts});
    } else { belum.push({id,nama,sektor}); }
  });
  function chunk(arr,n=4){ const out=Array.from({length:n},()=>[]); let idx=0,base=Math.floor(arr.length/n),rem=arr.length%n; for(let i=0;i<n;i++){const size=base+(i<rem?1:0); out[i]=arr.slice(idx,idx+size); idx+=size;} return out;}
  let html=`<h3>Sudah Input (${sudah.length} mesin)</h3>`+chunk(sudah).map(col=>`<div class="week-grid">`+col.map(c=>`<div class="monthly-card sudah"><div class="item"><strong>${c.id}</strong> — ${c.sektor}<br>${c.nama}<br><small>${c.ts}</small><span class="tooltip">Timestamp: ${c.ts}</span></div>`).join('')+`</div>`).join('')+`</div>`;
  html+=`<h3>Belum Input (${belum.length} mesin)</h3>`+chunk(belum).map(col=>`<div class="week-grid">`+col.map(c=>`<div class="monthly-card belum"><div class="item"><strong>${c.id}</strong> — ${c.sektor}<br>${c.nama}<span class="tooltip">Belum input</span></div>`).join('')+`</div>`).join('')+`</div>`;
  dataDisplay.innerHTML = html;
}

// --- Buttons ---
btnWeekly.addEventListener("click", async ()=>{
  resetMainButtons(); btnWeekly.classList.add("active"); weekButtons.style.display="flex"; resetWeekButtons();
  if(masterWeekly.length===0 || weeklyRows.length===0) await loadAll();
  dataDisplay.innerHTML="<div class='card'>Pilih week untuk melihat data</div>";
});

weekBtns.forEach(b=>{
  b.addEventListener("click", async ()=>{
    resetWeekButtons(); b.classList.add("active");
    dataDisplay.innerHTML=`<div class='card'>Loading week ${b.dataset.week}…</div>`;
    if(masterWeekly.length===0 || weeklyRows.length===0) await loadAll();
    renderWeekly(b.dataset.week);
  });
});

btnMonthly.addEventListener("click", async ()=>{
  resetMainButtons(); btnMonthly.classList.add("active"); weekButtons.style.display="none";
  dataDisplay.innerHTML="<div class='card'>Loading monthly data…</div>";
  if(masterMonthly.length===0 || monthlyRows.length===0) await loadAll();
  renderMonthly();
});

// --- Export Excel ---
btnExport.addEventListener("click", ()=>{
  if(masterWeekly.length===0 && masterMonthly.length===0) { alert("Data belum siap"); return; }
  const wb=XLSX.utils.book_new();
  if(masterWeekly.length>0){ const ws=XLSX.utils.json_to_sheet(masterWeekly); XLSX.utils.book_append_sheet(wb,ws,"Weekly"); }
  if(masterMonthly.length>0){ const ws=XLSX.utils.json_to_sheet(masterMonthly); XLSX.utils.book_append_sheet(wb,ws,"Monthly"); }
  XLSX.writeFile(wb,"Monitoring_GForm.xlsx");
});

btnRefresh.addEventListener("click", async ()=>{
  resetMainButtons(); btnRefresh.classList.add("active");
  dataDisplay.innerHTML="<div class='card'>Refreshing…</div>";
  await loadAll(); 
  if(btnWeekly.classList.contains("active")) renderWeekly(document.querySelector(".week-btn.active")?.dataset.week || 1);
  if(btnMonthly.classList.contains("active")) renderMonthly();
});

btnEL.addEventListener("click", ()=>{
  resetMainButtons(); btnEL.classList.add("active"); 
  dataDisplay.innerHTML="<div class='card'>Tampilkan foto / EL content di sini</div>";
});

// --- Init ---
window.addEventListener("load", async ()=>{
  loader.style.display="flex";
  await loadAll();
  loader.style.display="none";
  dataDisplay.innerHTML="<div class='card'>Pilih tombol untuk melihat data</div>";
});
</script>

</body>
</html>
