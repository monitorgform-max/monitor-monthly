<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MONITORING GFORM</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f7fa; color:#222; }
header { background:#1e5bb8; color:white; padding:15px; text-align:center; font-size:20px; font-weight:bold; position:fixed; top:0; left:0; right:0; z-index:1000; }
.wrap { padding:16px; padding-top:90px; /* space for fixed header + buttons */ }
.button-row { display:flex; gap:10px; margin-bottom:12px; position:fixed; top:60px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:999; }
.btn { padding:8px 16px; border:none; border-radius:6px; background:#1e5bb8; color:white; cursor:pointer; font-weight:bold; }
.btn.active { background:red; }
.week-row { display:flex; gap:8px; margin-bottom:12px; display:none; position:fixed; top:105px; left:0; right:0; padding:0 16px; background:#f5f7fa; z-index:998; }
.week-btn { padding:6px 12px; border:none; border-radius:6px; background:#666; color:white; cursor:pointer; font-weight:bold; }
.week-btn.active { background:red; }
#dataDisplay { margin-top:150px; overflow-y:auto; max-height:calc(100vh - 150px); padding-bottom:20px; }
.card { background:white; padding:10px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.week-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.item { border-bottom:1px solid #eee; padding:4px 0; font-size:13px; }
.chart-wrap { background:white; padding:10px; border-radius:8px; margin-top:14px; text-align:center;width: 400px;        /* ganti sesuai keinginan */
  height: 400px;       /* ganti sesuai keinginan */
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin: 20px auto;   /* top-center */
  text-align: center;
  position: relative;  /* penting supaya Chart.js responsive */ }
.chart-wrap canvas {  transform-origin:top:center; width: 100% !important;
  height: 100% !important; }
.card.sudah { background:#d4edda; }   /* hijau muda */
.card.belum { background:#f8d7da; }  /* merah muda */
.card h4 { margin:0 0 8px; font-size:14px; color:black; background:#eaeaea; padding:4px; border-radius:4px; }
.item { border-bottom:1px solid #eee; padding:4px 0; font-size:13px; }
.card {
  border-radius:8px;
  padding:6px;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.card.sudah { background:#d4edda; }
.card.belum { background:#f8d7da; }

.item {
  border-bottom:1px solid #eee;
  padding:4px 0;
  font-size:13px;
  position: relative;
  cursor: default;
  transition: background 0.15s ease, padding-left 0.15s ease;
}
.item:hover { background: rgba(0,0,0,0.05); padding-left:4px; }

/* Tooltip */
.item .tooltip {
  visibility: hidden;
  color: #fff;
  text-align: center;
  border-radius: 4px;
  padding: 2px 6px;
  position: absolute;
  z-index: 10;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.15s ease;
}
.card.sudah .tooltip { background: #28a745; }
.card.belum .tooltip { background: #dc3545; }
.item .tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
}
.card.sudah .tooltip::after { border-color: #28a745 transparent transparent transparent; }
.card.belum .tooltip::after { border-color: #dc3545 transparent transparent transparent; }
.item:hover .tooltip { visibility: visible; opacity: 1; }
.card.sudah { background:#d4edda; }
.card.belum { background:#f8d7da; }
.item { border-bottom:1px solid #eee; padding:6px 4px; font-size:13px; position:relative; transition: background .12s; }
.item:hover{ background: rgba(0,0,0,0.04); padding-left:4px; }
.item .tooltip{ visibility:hidden; opacity:0; transition:opacity .12s; position:absolute; bottom:125%; left:50%; transform:translateX(-50%); white-space:nowrap; padding:4px 6px; color:#fff; border-radius:4px; font-size:11px; z-index:10; }
.card.sudah .tooltip{ background:#28a745; }
.card.belum .tooltip{ background:#dc3545; }
.item:hover .tooltip{ visibility:visible; opacity:1; }
.chart-wrap{ width:400px; height:360px; margin:18px auto; position:relative; text-align:center; background:white; padding:10px; border-radius:8px; }
.chart-wrap canvas{ width:100% !important; height:100% !important; }
/* === Monthly Purple Pastel === */
.monthly-card.sudah {
  background: #e9d8fd;  /* ungu pastel muda */
  border: 1px solid #d6bcfa;
}

.monthly-card.belum {
  background: #f3e8ff; /* ungu pastel lebih soft */
  border: 1px solid #e9d5ff;
}

/* Hover biar tetap smooth */
.monthly-card .item:hover {
  background: rgba(120, 80, 200, 0.08);
}
/* ===== Efek Nimbul untuk Header Bar ===== */
.header-bar {
    transition: 0.25s ease;
}
.header-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ===== Efek Nimbul untuk Semua Card ===== */
.card {
    transition: 0.25s ease;
}
.card:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}
/* Tombol EL */
.el-btn {
    margin-left: auto;
    background: #4c6ef5;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.25s ease;
}

.el-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    background: #3b5bdb;
}


</style>
</head>
<body>

<header>MONITORING GFORM</header>

<div class="wrap">

  <!-- Buttons -->
  <div class="button-row">
    <button class="btn" id="btnWeekly">Weekly</button>
    <button class="btn" id="btnMonthly">Monthly</button>
    <button class="btn" id="btnExport">Export</button>
    <button class="btn" id="btnRefresh">Refresh</button>
    
    <button id="btnEL" class="el-btn">EL</button>
  </div>

  <!-- Weekly week buttons -->
  <div class="week-row" id="weekButtons">
    <button class="week-btn" data-week="1">W1</button>
    <button class="week-btn" data-week="2">W2</button>
    <button class="week-btn" data-week="3">W3</button>
    <button class="week-btn" data-week="4">W4</button>
  </div>

  <!-- Data Display -->
  <div id="dataDisplay"></div>
/* Popup Emot Tengah Layar */
#emotPopup {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
    z-index: 9999;

  
    align-items: center;
    justify-content: center;
}

#emotPopup .emot-box {
    font-size: 150px;
    animation: pop 0.25s ease-out;
}

@keyframes pop {
    from { transform: scale(0.6); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}
</div>

<script>
// ------------------
// State
// ------------------
const btnWeekly = document.getElementById("btnWeekly");
const btnMonthly = document.getElementById("btnMonthly");
const btnExport = document.getElementById("btnExport");
const btnRefresh = document.getElementById("btnRefresh");
const weekButtons = document.getElementById("weekButtons");
const weekBtns = document.querySelectorAll(".week-btn");
const dataDisplay = document.getElementById("dataDisplay");

function resetMainButtons() { [btnWeekly, btnMonthly, btnExport, btnRefresh].forEach(b=>b.classList.remove("active")); }
function resetWeekButtons() { weekBtns.forEach(b=>b.classList.remove("active")); }

// ------------------
// URLs
// ------------------
const MASTER_WEEKLY_CSV = "Data Mesin.csv"; 
const MASTER_MONTHLY_CSV = "Data Mesin Monthly.csv"; 

const WEEKLY_SHEET_ID = "19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck";
const WEEKLY_SHEET_NAME = "Form Responses 1";
const WEEKLY_SHEET_URL = `https://opensheet.elk.sh/${WEEKLY_SHEET_ID}/${encodeURIComponent(WEEKLY_SHEET_NAME)}`;

const MONTHLY_FORM_URL = "https://opensheet.elk.sh/19FeEccnYkZVAZo0lO-erbgLtJDAalG3IzwaiLympdck/Form%20Responses%201";

// ------------------
// Data
// ------------------
let weeklyRows=[], monthlyRows=[], masterWeekly=[], masterMonthly=[];
let chartWeekly=null, chartMonthly=null;

// ------------------
// Utils
// ------------------
function safe(v){ return v==null?"":String(v).trim(); }
function parseWeek(raw){ const m=String(raw).match(/(\d)/); const n=m?parseInt(m[1],10):1; return (n>=1 && n<=4)?n:1; }
async function loadCSV(url){ return new Promise(resolve=>{ Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:()=>resolve([])}); }); }

// ------------------
// Load all data
// ------------------
async function loadAll(){
  masterWeekly = await loadCSV(MASTER_WEEKLY_CSV);
  masterMonthly = await loadCSV(MASTER_MONTHLY_CSV);
  weeklyRows = await fetch(WEEKLY_SHEET_URL).then(r=>r.json()).catch(()=>[]);
  monthlyRows = await fetch(MONTHLY_FORM_URL).then(r=>r.json()).catch(()=>[]);
  console.log("Data loaded:", masterWeekly.length,"weekly,", masterMonthly.length,"monthly");
}

// ------------------
// Render Weekly per week
// ------------------
function renderWeekly(w){
  const list = masterWeekly.filter(m=>parseWeek(m.WEEK)===parseInt(w));
  const sudahList = [];
  const belumList = [];

  list.forEach(m=>{
    const id = safe(m["ID Mesin"]);
    const match = weeklyRows.find(r=>safe(r["ID Mesin"])===id);
    if(match) sudahList.push(m);
    else belumList.push(m);
  });

  // helper split array menjadi 4 kolom
  function chunkInto(arr){
    const n=4;
    const out = Array.from({length:n}, ()=>[]);
    if(arr.length===0) return out;
    const base = Math.floor(arr.length/n);
    const rem  = arr.length%n;
    let idx = 0;
    for(let i=0;i<n;i++){
      const size = base + (i<rem?1:0);
      out[i] = arr.slice(idx, idx+size);
      idx += size;
    }
    return out;
  }

  // GRID SUDAH
  let html = `<h3>Sudah Input: ${sudahList.length} mesin</h3>`;
  const colsSudah = chunkInto(sudahList);
  html += `<div class="week-grid">` + colsSudah.map(col=>{
    return `<div class="card sudah">` + col.map(m=>{
      const ts = safe((weeklyRows.find(r=>safe(r["ID Mesin"])===safe(m["ID Mesin"])) || {}).Timestamp) || "â€”";
      return `<div class="item"><strong>${safe(m["ID Mesin"])}</strong> â€” ${safe(m.SEKTOR)||"â€”"}<br>${safe(m["Nama Lokasi"])||"â€”"}<br>
              <small>${ts}</small>
              <span class="tooltip">Timestamp: ${ts}</span>
              </div>`;
    }).join("") + `</div>`;
  }).join("") + `</div>`;

  // GRID BELUM
  html += `<h3>Belum Input: ${belumList.length} mesin</h3>`;
  const colsBelum = chunkInto(belumList);
  html += `<div class="week-grid">` + colsBelum.map(col=>{
    return `<div class="card belum">` + col.map(m=>{
      return `<div class="item"><strong>${safe(m["ID Mesin"])}</strong> â€” ${safe(m.SEKTOR)||"â€”"}<br>${safe(m["Nama Lokasi"])||"â€”"}
              <span class="tooltip">Belum input</span>
              </div>`;
    }).join("") + `</div>`;
  }).join("") + `</div>`;
  
  // PIE CHART Weekly
  html += "<div class='chart-wrap'><h4>Grafik Weekly</h4><canvas id='chartWeekly'></canvas></div>";
  html += "<div class='chart-wrap'><h4>Grafik Monthly</h4><canvas id='chartMonthly'></canvas></div>";


  dataDisplay.innerHTML = html;

  // pie chart data
  const sektorCount={};
  sudahList.forEach(m=>{
    const s = safe(m.SEKTOR)||"â€”";
    sektorCount[s] = (sektorCount[s]||0)+1;
  });

  const ctx = document.getElementById("chartWeekly").getContext("2d");
  if(chartWeekly) chartWeekly.destroy();
  chartWeekly = new Chart(ctx,{
    type:"pie",
    data:{
      labels: Object.keys(sektorCount).length? Object.keys(sektorCount):["No Data"],
      datasets:[{data:Object.values(sektorCount).length?Object.values(sektorCount):[1]}]
    },
    options:{responsive:true, maintainAspectRatio:false}
  });
}


// ------------------
// Render Monthly
// ------------------
function renderMonthly(){
  // safety: pastikan masterMonthly & monthlyRows tersedia
  console.log("renderMonthly() start --- masterMonthly, monthlyRows lengths:", masterMonthly.length, monthlyRows.length);

  // helper split into 4 columns (seimbang)
  function chunkInto(arr, n=4){
    const out = Array.from({length:n}, ()=>[]);
    if(arr.length === 0) return out;
    const base = Math.floor(arr.length / n), rem = arr.length % n;
    let idx = 0;
    for(let i=0;i<n;i++){
      const size = base + (i < rem ? 1 : 0);
      out[i] = arr.slice(idx, idx + size);
      idx += size;
    }
    return out;
  }

  // normalize field name function (cari kolom yang paling mungkin)
  function getField(obj, candidates){
    if(!obj) return "";
    for(const k of candidates){
      if(typeof obj[k] !== "undefined") return obj[k];
      // coba case-insensitive
      const found = Object.keys(obj).find(x => x.toLowerCase() === k.toLowerCase());
      if(found) return obj[found];
    }
    return "";
  }

  const sudah = [];
  const belum = [];
  const sektorCount = {};

  // pastikan kita pakai field names yang fleksibel
  // kandidat nama field di masterMonthly: "ID Mesin","ID","MACHINE ID"
  // kandidat sektor: "SEKTOR","Sektor","Sektor / Area"
  // kandidat nama lokasi: "Nama Lokasi","NAMA LOKASI","Lokasi"
  // kandidat timestamp di monthlyRows: "Timestamp","Waktu","timestamp"
  for(const m of masterMonthly){
    const id = safe(getField(m, ["ID Mesin","MACHINE ID","ID","Machine ID"]));
    if(!id) continue; // skip kosong
    const sektor = safe(getField(m, ["SEKTOR","Sektor","Sektor / Area","Area"]));
    const nama  = safe(getField(m, ["Nama Lokasi","NAMA LOKASI","Lokasi","Location"]));

    // cari match di monthlyRows (sheet) â€” gunakan same flexible field
    const match = monthlyRows.find(r =>{
      const rid = safe(getField(r, ["ID Mesin","MACHINE ID","ID","Machine ID"]));
      return rid && rid === id;
    });

    if(match){
      const ts = safe(getField(match, ["Timestamp","timestamp","Waktu","Waktu Input"])) || "â€”";
      sudah.push({id,sektor,nama,timestamp:ts});
      sektorCount[sektor || "â€”"] = (sektorCount[sektor || "â€”"]||0)+1;
    } else {
      belum.push({id,sektor,nama});
    }
  }

  // buat kolom 4x seimbang
  const colsSudah = chunkInto(sudah,4);
  const colsBelum = chunkInto(belum,4);

  // render HTML: judul jumlah + grid 4 kolom
  let html = `<h3>Sudah Input: ${sudah.length} mesin</h3>`;
  html += `<div class="week-grid">` + colsSudah.map(col=>{
    return `<div class="card monthly-card sudah">` + (col.length ? col.map(it=>
      `<div class="item"><strong>${it.id}</strong> â€” ${it.sektor || ""}<br>${it.nama || ""}<br><small>${it.timestamp}</small><span class="tooltip">Timestamp: ${it.timestamp}</span></div>`
    ).join("") : `<div class="item">â€”</div>`) + `</div>`;
  }).join("") + `</div>`;

  html += `<h3>Belum Input: ${belum.length} mesin</h3>`;
  html += `<div class="week-grid">` + colsBelum.map(col=>{
    return `<div class="card monthly-card belum">` + (col.length ? col.map(it=>
      `<div class="item"><strong>${it.id}</strong> â€” ${it.sektor || ""}<br>${it.nama || ""}<span class="tooltip">Belum input</span></div>`
    ).join("") : `<div class="item"></div>`) + `</div>`;
  }).join("") + `</div>`;

  const ctx = document.getElementById("chartMonthly").getContext("2d");
  if(chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(ctx,{ type:"pie", data:{ labels:Object.keys(sektorCount).length?Object.keys(sektorCount):["No Data"], datasets:[{data:Object.values(sektorCount).length?Object.values(sektorCount):[1]}] }, options:{responsive:false}});
}

// ------------------
// Buttons logic
// ------------------
btnWeekly.addEventListener("click",()=>{
  resetMainButtons(); btnWeekly.classList.add("active");
  weekButtons.style.display="flex"; dataDisplay.innerHTML=""; resetWeekButtons();
});
weekBtns.forEach(b=>{
  b.addEventListener("click",()=>{
    resetWeekButtons(); b.classList.add("active");
    renderWeekly(b.dataset.week);
  });
});
btnMonthly.addEventListener("click", async ()=>{
  resetMainButtons(); 
  btnMonthly.classList.add("active");
  weekButtons.style.display="none"; 
  await loadAll(); // pastikan data loaded
  renderMonthly();
});
btnExport.addEventListener("click",()=>{
  resetMainButtons(); btnExport.classList.add("active");
  const rows=[];
  masterWeekly.forEach(m=>{
    const id = safe(m["ID Mesin"]);
    const nama = safe(m["Nama Lokasi"]);
    const sektor = safe(m.SEKTOR)||"â€”";
    const weeklyMatch = weeklyRows.find(r=>safe(r["ID Mesin"])===id);
    const monthlyMatch = monthlyRows.find(r=>safe(r["ID Mesin"])===id);
    rows.push({ID:id, Nama_Lokasi:nama, Sektor:sektor, Weekly: weeklyMatch?weeklyMatch.Timestamp:"â€”", Monthly: monthlyMatch?monthlyMatch.Timestamp:"â€”"});
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Monitoring");
  XLSX.writeFile(wb,"Monitoring.xlsx");
  dataDisplay.innerHTML="<div class='card'>Export berhasil!</div>";
});
btnRefresh.addEventListener("click",()=>{
  resetMainButtons(); btnRefresh.classList.add("active");
  dataDisplay.innerHTML="<div class='card'>Refreshâ€¦</div>";
  loadAll().then(()=>dataDisplay.innerHTML="<div class='card'>Data terbaru sudah dimuat.</div>");
});

// Initial load
loadAll();
const btnEL = document.getElementById("btnEL");
const emotPopup = document.getElementById("emotPopup");

btnEL.addEventListener("click", () => {
    emotPopup.style.display = "flex";
});

// klik di luar emot â†’ close
emotPopup.addEventListener("click", (e) => {
    if (e.target === emotPopup) {
        emotPopup.style.display = "none";
    }
});
</script>
<!-- â¬‡â¬‡â¬‡ TEMPATKAN DI SINI â¬‡â¬‡â¬‡ -->
<div id="emotPopup">
    <div class="emot-box">ðŸ˜Ž</div>
</div>
<!-- â¬†â¬†â¬† TEMPATKAN DI SINI â¬†â¬†â¬† -->
</body>
</html>











